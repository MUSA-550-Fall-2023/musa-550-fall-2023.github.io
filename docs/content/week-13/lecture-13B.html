<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Geospatial Data Science in Python - Lecture 13B: Predictive modeling with scikit-learn, continued</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../files/favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Geospatial Data Science in Python</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../syllabus.html" rel="" target="">
 <span class="menu-text">Syllabus</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-schedule" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Schedule</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-schedule">    
        <li>
    <a class="dropdown-item" href="../../schedule/401.html" rel="" target="">
 <span class="dropdown-text">Section 401</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../schedule/402.html" rel="" target="">
 <span class="dropdown-text">Section 402</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../content/index.html" rel="" target="">
 <span class="menu-text">Content</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-assignments" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Assignments</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-assignments">    
        <li>
    <a class="dropdown-item" href="../../assignment/overview.html" rel="" target="">
 <span class="dropdown-text">Overview</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../assignment/401/schedule.html" rel="" target="">
 <span class="dropdown-text">Section 401</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../assignment/402/schedule.html" rel="" target="">
 <span class="dropdown-text">Section 402</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../resource/index.html" rel="" target="">
 <span class="menu-text">Resources</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-box-arrow-up-right"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/MUSA-550-Fall-2023">
            GitHub
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://canvas.upenn.edu/courses/1740535">
            Canvas
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://edstem.org/us/courses/42616/discussion/">
            Ed Discussion
            </a>
          </li>
      </ul>
    </div>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content column-page" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lecture 13B: Predictive modeling with scikit-learn, continued</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;skip&quot;}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> hvplot.pandas</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;skip&quot;}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>pd.options.display.max_columns <span class="op">=</span> <span class="dv">999</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Dec 1, 2023</li>
<li>Section 401</li>
</ul>
<section id="picking-up-where-we-left-off" class="level2">
<h2 class="anchored" data-anchor-id="picking-up-where-we-left-off">Picking up where we left off</h2>
<p>We’ll start by recapping the exercise from last lecture: adding additional distance-based features to our housing price model…</p>
</section>
<section id="spatial-amenitydisamenity-features" class="level2">
<h2 class="anchored" data-anchor-id="spatial-amenitydisamenity-features">Spatial amenity/disamenity features</h2>
<p><strong>The strategy</strong></p>
<ul>
<li>Get the data for a certain type of amenity, e.g., restaurants, bars, or disamenity, e.g., crimes
<ul>
<li>Data sources: 311 requests, crime incidents, Open Street Map</li>
</ul></li>
<li>Use scikit learn’s nearest neighbor algorithm to calculate the distance from each sale to its nearest neighbor in the amenity/disamenity datasets</li>
</ul>
</section>
<section id="examples-of-new-possible-features" class="level2">
<h2 class="anchored" data-anchor-id="examples-of-new-possible-features">Examples of new possible features…</h2>
<p>Distance from each sale to:</p>
<ul>
<li><strong>Graffiti 311 Calls (last lecture)</strong></li>
<li><strong>Subway Stops (last lecture)</strong></li>
<li>Universities</li>
<li>Parks</li>
<li>City Hall</li>
<li>New Construction Permits</li>
<li>Aggravated Assaults</li>
<li>Abandoned Vehicle 311 Calls</li>
</ul>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Models</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model selection</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split, cross_val_score, GridSearchCV</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipelines</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> make_pipeline</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Preprocessing</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler, PolynomialFeatures, OneHotEncoder</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Neighbors</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.neighbors <span class="im">import</span> NearestNeighbors</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_carto_data(table_name, where<span class="op">=</span><span class="va">None</span>, limit<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Download data from CARTO given a specific table name and</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">    optionally a where statement or limit.</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the CARTO API url</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    carto_url <span class="op">=</span> <span class="st">"https://phl.carto.com/api/v2/sql"</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the query</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    query <span class="op">=</span> <span class="ss">f"SELECT * FROM </span><span class="sc">{</span>table_name<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add a where</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> where <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        query <span class="op">=</span> query <span class="op">+</span> <span class="ss">f" WHERE </span><span class="sc">{</span>where<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add a limit</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> limit <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        query <span class="op">=</span> query <span class="op">+</span> <span class="ss">f" LIMIT </span><span class="sc">{</span>limit<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make the request</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> {<span class="st">"q"</span>: query, <span class="st">"format"</span>: <span class="st">"geojson"</span>}</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.get(carto_url, params<span class="op">=</span>params)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make the GeoDataFrame</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gpd.GeoDataFrame.from_features(response.json(), crs<span class="op">=</span><span class="st">"EPSG:4326"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Load and clean the data using the utility function above:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the CARTO API url</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>carto_url <span class="op">=</span> <span class="st">"https://phl.carto.com/api/v2/sql"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># The table name</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>table_name <span class="op">=</span> <span class="st">"opa_properties_public"</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Only pull 2022 sales for single family residential properties</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>where <span class="op">=</span> <span class="st">"sale_date &gt;= '2022-01-01' AND sale_date &lt; '2023-01-01'"</span> </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>where <span class="op">=</span> where <span class="op">+</span> <span class="st">" AND category_code_description IN ('SINGLE FAMILY', 'Single Family')"</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the query</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>salesRaw <span class="op">=</span> get_carto_data(table_name, where<span class="op">=</span>where)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: put it a reproducible order for test/training splits later</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>salesRaw <span class="op">=</span> salesRaw.sort_values(<span class="st">"parcel_number"</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co"># The feature columns we want to use</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> [</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sale_price"</span>,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_livable_area"</span>,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_area"</span>,</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"garage_spaces"</span>,</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fireplaces"</span>,</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"number_of_bathrooms"</span>,</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"number_of_bedrooms"</span>,</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"number_stories"</span>,</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"exterior_condition"</span>,</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"zip_code"</span>,</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"geometry"</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Trim to these columns and remove NaNs</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>sales <span class="op">=</span> salesRaw[cols].dropna()</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Trim zip code to only the first five digits</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>sales[<span class="st">'zip_code'</span>] <span class="op">=</span> sales[<span class="st">'zip_code'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.<span class="bu">slice</span>(<span class="dv">0</span>, <span class="dv">5</span>)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Trim very low and very high sales</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> (sales[<span class="st">'sale_price'</span>] <span class="op">&gt;</span> <span class="dv">3000</span>) <span class="op">&amp;</span> (sales[<span class="st">'sale_price'</span>] <span class="op">&lt;</span> <span class="fl">1e6</span>)</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>sales <span class="op">=</span> sales.loc[valid]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(sales)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>17695</code></pre>
</div>
</div>
<p>Add new distance-based features:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_xy_from_geometry(df):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Return a numpy array with two columns, where the </span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">    first holds the `x` geometry coordinate and the second </span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">    column holds the `y` geometry coordinate</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Note: this works with both Point() and Polygon() objects.</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NEW: use the centroid.x and centroid.y to support Polygon() and Point() geometries </span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> df.geometry.centroid.x</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df.geometry.centroid.y</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.column_stack((x, y)) <span class="co"># stack as columns</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to meters and EPSG=3857</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>sales_3857 <span class="op">=</span> sales.to_crs(epsg<span class="op">=</span><span class="dv">3857</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract x/y for sales</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>salesXY <span class="op">=</span> get_xy_from_geometry(sales_3857)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="new-feature-311-graffiti-calls" class="level3">
<h3 class="anchored" data-anchor-id="new-feature-311-graffiti-calls">New feature: 311 Graffiti Calls</h3>
<p>Source: <a href="https://www.opendataphilly.org/dataset/311-service-and-information-requests">https://www.opendataphilly.org/dataset/311-service-and-information-requests</a></p>
<p><a href="https://metadata.phila.gov/#home/datasetdetails/5543864d20583086178c4e98/representationdetails/5762e19fa237544b2ecfe722/">Metadata</a></p>
<p>Download the data:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select only those for grafitti and in 2022</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>where <span class="op">=</span> <span class="st">"requested_datetime &gt;= '01-01-2022' and requested_datetime &lt; '01-01-2023'"</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>where <span class="op">=</span> where <span class="op">+</span> <span class="st">" AND service_name = 'Graffiti Removal'"</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Pull the subset we want</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>graffiti <span class="op">=</span> get_carto_data(<span class="st">"public_cases_fc"</span>, where<span class="op">=</span>where)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove rows with missing geometries</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>not_missing <span class="op">=</span> <span class="op">~</span>graffiti.geometry.is_empty <span class="op">&amp;</span> graffiti.geometry.notna()</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>graffiti <span class="op">=</span> graffiti.loc[not_missing]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get the x/y coordinates for the grafitti calls:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to meters in EPSG=3857</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>graffiti_3857 <span class="op">=</span> graffiti.to_crs(epsg<span class="op">=</span><span class="dv">3857</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract x/y for grafitti calls</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>graffitiXY <span class="op">=</span> get_xy_from_geometry(graffiti_3857)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Run the neighbors algorithm to calculate the new feature:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 1: Initialize the algorithm</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>nbrs <span class="op">=</span> NearestNeighbors(n_neighbors<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 2: Fit the algorithm on the "neighbors" dataset</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>nbrs.fit(graffitiXY)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 3: Get distances for sale to neighbors</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>grafDists, grafIndices <span class="op">=</span> nbrs.kneighbors(salesXY) </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 4: Get average distance to neighbors</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>avgGrafDist <span class="op">=</span> grafDists.mean(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Set zero distances to be small, but nonzero</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co"># IMPORTANT: THIS WILL AVOID INF DISTANCES WHEN DOING THE LOG</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>avgGrafDist[avgGrafDist<span class="op">==</span><span class="dv">0</span>] <span class="op">=</span> <span class="fl">1e-5</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 5: Add the new feature</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>sales[<span class="st">'logDistGraffiti'</span>] <span class="op">=</span> np.log10(avgGrafDist)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="new-feature-subway-stops" class="level3">
<h3 class="anchored" data-anchor-id="new-feature-subway-stops">New feature: Subway stops</h3>
<p>Use the <code>osmnx</code> package to get subway stops in Philly —&nbsp;we can use the <code>ox.geometries_from_polygon()</code> function.</p>
<ul>
<li>To select subway stations, we can use <code>station=subway</code>: see the <a href="https://wiki.openstreetmap.org/wiki/Tag:station%3Dsubway">OSM Wikipedia</a></li>
<li>See <a href="https://musa-550-fall-2023.github.io/content/week-5/lecture-5A.html">Lecture 5A</a> for a reminder on osmnx!</li>
</ul>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;fragment&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> osmnx <span class="im">as</span> ox</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get the geometry polygon for the Philadelphia city limits:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="39">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Download the Philadelphia city limits</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"https://opendata.arcgis.com/datasets/405ec3da942d4e20869d4e1449a2be48_0.geojson"</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>city_limits <span class="op">=</span> gpd.read_file(url).to_crs(epsg<span class="op">=</span><span class="dv">3857</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the geometry from the city limits</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>city_limits_outline <span class="op">=</span> city_limits.to_crs(epsg<span class="op">=</span><span class="dv">4326</span>).squeeze().geometry</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="40">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>city_limits_outline</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<p><img src="lecture-13B_files/figure-html/cell-15-output-1.svg" class="img-fluid"></p>
</div>
</div>
<p>Use osmnx to query OpenStreetMap to get all subway stations within the city limits:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="41">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the subway stops within the city limits</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>subway <span class="op">=</span> ox.features_from_polygon(city_limits_outline, tags<span class="op">=</span>{<span class="st">"station"</span>: <span class="st">"subway"</span>})</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to 3857 (meters)</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>subway <span class="op">=</span> subway.to_crs(epsg<span class="op">=</span><span class="dv">3857</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/nhand/mambaforge/envs/musa-550-fall-2023/lib/python3.10/site-packages/shapely/predicates.py:798: RuntimeWarning: invalid value encountered in intersects
  return lib.intersects(a, b, **kwargs)
/Users/nhand/mambaforge/envs/musa-550-fall-2023/lib/python3.10/site-packages/shapely/set_operations.py:340: RuntimeWarning: invalid value encountered in union
  return lib.union(a, b, **kwargs)</code></pre>
</div>
</div>
<p>Get the distance to the nearest subway station (<span class="math inline">\(k=1\)</span>):</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="42">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 1: x/y coordinates of subway stops (in EPGS=3857)</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>subwayXY <span class="op">=</span> get_xy_from_geometry(subway.to_crs(epsg<span class="op">=</span><span class="dv">3857</span>))</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 2: Initialize the algorithm</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>nbrs <span class="op">=</span> NearestNeighbors(n_neighbors<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 3: Fit the algorithm on the "neighbors" dataset</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>nbrs.fit(subwayXY)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 4: Get distances for sale to neighbors</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>subwayDists, subwayIndices <span class="op">=</span> nbrs.kneighbors(salesXY)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 5: add back to the original dataset</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>sales[<span class="st">"logDistSubway"</span>] <span class="op">=</span> np.log10(subwayDists.mean(axis<span class="op">=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="43">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>sales.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">sale_price</th>
<th data-quarto-table-cell-role="th">total_livable_area</th>
<th data-quarto-table-cell-role="th">total_area</th>
<th data-quarto-table-cell-role="th">garage_spaces</th>
<th data-quarto-table-cell-role="th">fireplaces</th>
<th data-quarto-table-cell-role="th">number_of_bathrooms</th>
<th data-quarto-table-cell-role="th">number_of_bedrooms</th>
<th data-quarto-table-cell-role="th">number_stories</th>
<th data-quarto-table-cell-role="th">exterior_condition</th>
<th data-quarto-table-cell-role="th">zip_code</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">logDistGraffiti</th>
<th data-quarto-table-cell-role="th">logDistSubway</th>
<th data-quarto-table-cell-role="th">logDistParks</th>
<th data-quarto-table-cell-role="th">logDistCityHall</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">5703</td>
<td>450000</td>
<td>1785.0</td>
<td>1625.0</td>
<td>1.0</td>
<td>0.0</td>
<td>2.0</td>
<td>3.0</td>
<td>3.0</td>
<td>4</td>
<td>19147</td>
<td>POINT (-75.14860 39.93145)</td>
<td>2.097791</td>
<td>3.337322</td>
<td>2.055013</td>
<td>3.540530</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12759</td>
<td>670000</td>
<td>2244.0</td>
<td>1224.0</td>
<td>0.0</td>
<td>0.0</td>
<td>3.0</td>
<td>4.0</td>
<td>3.0</td>
<td>3</td>
<td>19147</td>
<td>POINT (-75.14817 39.93101)</td>
<td>2.215476</td>
<td>3.350337</td>
<td>1.790892</td>
<td>3.550316</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10179</td>
<td>790000</td>
<td>2514.0</td>
<td>1400.0</td>
<td>1.0</td>
<td>0.0</td>
<td>0.0</td>
<td>3.0</td>
<td>2.0</td>
<td>1</td>
<td>19147</td>
<td>POINT (-75.14781 39.93010)</td>
<td>2.194509</td>
<td>3.362296</td>
<td>2.042033</td>
<td>3.566690</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2807</td>
<td>195000</td>
<td>1358.0</td>
<td>840.0</td>
<td>0.0</td>
<td>0.0</td>
<td>2.0</td>
<td>3.0</td>
<td>3.0</td>
<td>4</td>
<td>19147</td>
<td>POINT (-75.14887 39.93026)</td>
<td>2.212881</td>
<td>3.339347</td>
<td>1.857231</td>
<td>3.557546</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12637</td>
<td>331000</td>
<td>868.0</td>
<td>546.0</td>
<td>0.0</td>
<td>0.0</td>
<td>2.0</td>
<td>2.0</td>
<td>2.0</td>
<td>3</td>
<td>19147</td>
<td>POINT (-75.14881 39.93012)</td>
<td>2.206706</td>
<td>3.340635</td>
<td>1.942614</td>
<td>3.560202</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="now-lets-run-the-model" class="level2">
<h2 class="anchored" data-anchor-id="now-lets-run-the-model">Now, let’s run the model…</h2>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="44">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Numerical columns</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>num_cols <span class="op">=</span> [</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_livable_area"</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_area"</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"garage_spaces"</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fireplaces"</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"number_of_bathrooms"</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"number_of_bedrooms"</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"number_stories"</span>,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"logDistGraffiti"</span>, <span class="co"># NEW</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"logDistSubway"</span> <span class="co"># NEW</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Categorical columns</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>cat_cols <span class="op">=</span> [<span class="st">"exterior_condition"</span>, <span class="st">"zip_code"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="45">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up the column transformer with two transformers</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>transformer <span class="op">=</span> ColumnTransformer(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    transformers<span class="op">=</span>[</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"num"</span>, StandardScaler(), num_cols),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"cat"</span>, OneHotEncoder(handle_unknown<span class="op">=</span><span class="st">"ignore"</span>), cat_cols),</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="46">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the pipeline</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: only use 20 estimators here so it will run in a reasonable time</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> make_pipeline(</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    transformer, RandomForestRegressor(n_estimators<span class="op">=</span><span class="dv">20</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="47">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Split the data 70/30</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>train_set, test_set <span class="op">=</span> train_test_split(sales, test_size<span class="op">=</span><span class="fl">0.3</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># the target labels</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> np.log(train_set[<span class="st">"sale_price"</span>])</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> np.log(test_set[<span class="st">"sale_price"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="48">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the training set</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># REMINDER: use the training dataframe objects here rather than numpy array</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>pipe.fit(train_set, y_train)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="49">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># What's the test score?</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># REMINDER: use the test dataframe rather than numpy array</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>pipe.score(test_set, y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>0.5858433162524823</code></pre>
</div>
</div>
<section id="can-we-improve-on-this" class="level3">
<h3 class="anchored" data-anchor-id="can-we-improve-on-this">Can we improve on this?</h3>
</section>
</section>
<section id="exercise-from-last-lecture-how-about-other-spatial-features" class="level2">
<h2 class="anchored" data-anchor-id="exercise-from-last-lecture-how-about-other-spatial-features">Exercise from last lecture: How about other spatial features?</h2>
<ul>
<li>I’ve listed out several other types of potential sources of new distance-based features from OpenDataPhilly</li>
<li>Choose a few and add new features</li>
<li>Re-fit the model and evalute the performance on the test set and feature importances</li>
</ul>
<section id="universities" class="level3">
<h3 class="anchored" data-anchor-id="universities">1. Universities</h3>
<p>New feature: Distance to the <em>nearest</em> university/college</p>
<ul>
<li>Source: <a href="https://www.opendataphilly.org/dataset/philadelphia-universities-and-colleges">OpenDataPhilly</a></li>
<li><a href="https://opendata.arcgis.com/api/v3/datasets/8ad76bc179cf44bd9b1c23d6f66f57d1_0/downloads/data?format=geojson&amp;spatialRefId=4326">GeoJSON URL</a></li>
</ul>
<div class="cell" data-tags="[]" data-execution_count="61">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the data</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"https://opendata.arcgis.com/api/v3/datasets/8ad76bc179cf44bd9b1c23d6f66f57d1_0/downloads/data?format=geojson&amp;spatialRefId=4326"</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>univs <span class="op">=</span> gpd.read_file(url)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the X/Y</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>univXY <span class="op">=</span> get_xy_from_geometry(univs.to_crs(epsg<span class="op">=</span><span class="dv">3857</span>))</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the k nearest algorithm</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>nbrs <span class="op">=</span> NearestNeighbors(n_neighbors<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>nbrs.fit(univXY)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>univDists, _ <span class="op">=</span> nbrs.kneighbors(salesXY)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the new feature</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>sales[<span class="st">'logDistUniv'</span>] <span class="op">=</span> np.log10(univDists.mean(axis<span class="op">=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="62">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>), facecolor<span class="op">=</span>plt.get_cmap(<span class="st">'viridis'</span>)(<span class="dv">0</span>))</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> salesXY[:,<span class="dv">0</span>]</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> salesXY[:,<span class="dv">1</span>]</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>ax.hexbin(x, y, C<span class="op">=</span>np.log10(univDists.mean(axis<span class="op">=</span><span class="dv">1</span>)), gridsize<span class="op">=</span><span class="dv">60</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the city limits</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>city_limits.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>, linewidth<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>ax.set_aspect(<span class="st">"equal"</span>)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Distance to Nearest University/College"</span>, fontsize<span class="op">=</span><span class="dv">16</span>, color<span class="op">=</span><span class="st">'white'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lecture-13B_files/figure-html/cell-26-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="parks" class="level3">
<h3 class="anchored" data-anchor-id="parks">2. Parks</h3>
<p>New feature: Distance to the <em>nearest</em> park centroid</p>
<ul>
<li>Source: <a href="https://www.opendataphilly.org/dataset/ppr-properties">OpenDataPhilly</a></li>
<li><a href="https://opendata.arcgis.com/datasets/d52445160ab14380a673e5849203eb64_0.geojson">GeoJSON URL</a></li>
</ul>
<p><strong>Notes</strong> - The park geometries are <em>polygons</em>, so you’ll need to get the <code>x</code> and <code>y</code> coordinates of the park <em>centroids</em> and calculate the distance to these centroids. - You can use the <code>geometry.centroid.x</code> and <code>geometry.centroid.y</code> values to access these coordinates.</p>
<div class="cell" data-tags="[]" data-execution_count="63">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the data</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"https://opendata.arcgis.com/datasets/d52445160ab14380a673e5849203eb64_0.geojson"</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>parks <span class="op">=</span> gpd.read_file(url)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the X/Y</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>parksXY <span class="op">=</span> get_xy_from_geometry(parks.to_crs(epsg<span class="op">=</span><span class="dv">3857</span>))</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the k nearest algorithm</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>nbrs <span class="op">=</span> NearestNeighbors(n_neighbors<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>nbrs.fit(parksXY)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>parksDists, _ <span class="op">=</span> nbrs.kneighbors(salesXY)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the new feature</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>sales[<span class="st">"logDistParks"</span>] <span class="op">=</span> np.log10(parksDists.mean(axis<span class="op">=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="64">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>), facecolor<span class="op">=</span>plt.get_cmap(<span class="st">"viridis"</span>)(<span class="dv">0</span>))</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> salesXY[:, <span class="dv">0</span>]</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> salesXY[:, <span class="dv">1</span>]</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>ax.hexbin(x, y, C<span class="op">=</span>np.log10(parksDists.mean(axis<span class="op">=</span><span class="dv">1</span>)), gridsize<span class="op">=</span><span class="dv">60</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the city limits</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>city_limits.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">"none"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>, linewidth<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>ax.set_aspect(<span class="st">"equal"</span>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Distance to Nearest Park"</span>, fontsize<span class="op">=</span><span class="dv">16</span>, color<span class="op">=</span><span class="st">"white"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lecture-13B_files/figure-html/cell-28-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="city-hall" class="level3">
<h3 class="anchored" data-anchor-id="city-hall">3. City Hall</h3>
<p>New feature: Distance to City Hall.</p>
<ul>
<li>Source: <a href="https://www.opendataphilly.org/dataset/city-landmarks">OpenDataPhilly</a></li>
<li><a href="http://data-phl.opendata.arcgis.com/datasets/5146960d4d014f2396cb82f31cd82dfe_0.geojson">GeoJSON URL</a></li>
</ul>
<p><strong>Notes</strong></p>
<ul>
<li>To identify City Hall, you’ll need to pull data where “NAME=‘City Hall’” and “FEAT_TYPE=‘Municipal Building’”</li>
<li>As with the parks, the geometry will be a <em>polygon</em>, so you should calculate the distance to the <em>centroid</em> of the City Hall polygon</li>
</ul>
<div class="cell" data-tags="[]" data-execution_count="66">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the data</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"http://data-phl.opendata.arcgis.com/datasets/5146960d4d014f2396cb82f31cd82dfe_0.geojson"</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>landmarks <span class="op">=</span> gpd.read_file(url)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Trim to City Hall</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>cityHall <span class="op">=</span> landmarks.query(<span class="st">"NAME == 'City Hall' and FEAT_TYPE == 'Municipal Building'"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="67">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the X/Y</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>cityHallXY <span class="op">=</span> get_xy_from_geometry(cityHall.to_crs(epsg<span class="op">=</span><span class="dv">3857</span>))</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the k nearest algorithm</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>nbrs <span class="op">=</span> NearestNeighbors(n_neighbors<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>nbrs.fit(cityHallXY)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>cityHallDist, _ <span class="op">=</span> nbrs.kneighbors(salesXY)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the new feature</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>sales[<span class="st">"logDistCityHall"</span>] <span class="op">=</span> np.log10(cityHallDist.mean(axis<span class="op">=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="68">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>), facecolor<span class="op">=</span>plt.get_cmap(<span class="st">"viridis"</span>)(<span class="dv">0</span>))</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> salesXY[:, <span class="dv">0</span>]</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> salesXY[:, <span class="dv">1</span>]</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>ax.hexbin(x, y, C<span class="op">=</span>np.log10(cityHallDist.mean(axis<span class="op">=</span><span class="dv">1</span>)), gridsize<span class="op">=</span><span class="dv">60</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the city limits</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>city_limits.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">"none"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>, linewidth<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>ax.set_aspect(<span class="st">"equal"</span>)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Distance to City Hall"</span>, fontsize<span class="op">=</span><span class="dv">16</span>, color<span class="op">=</span><span class="st">"white"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lecture-13B_files/figure-html/cell-31-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="residential-construction-permits" class="level3">
<h3 class="anchored" data-anchor-id="residential-construction-permits">4. Residential Construction Permits</h3>
<p>New feature: Distance to the 5 nearest residential construction permits from 2022</p>
<ul>
<li>Source: <a href="https://www.opendataphilly.org/dataset/licenses-and-inspections-building-permits">OpenDataPhilly</a></li>
<li>CARTO table name: “permits”</li>
</ul>
<p><strong>Notes</strong></p>
<ul>
<li>You can pull new construction permits only by selecting where <code>permitdescription</code> equals ‘RESIDENTRIAL CONSTRUCTION PERMIT’</li>
<li>You can select permits from only 2022 using the <code>permitissuedate</code> column</li>
</ul>
<div class="cell" data-tags="[]" data-execution_count="69">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Table name</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>table_name <span class="op">=</span> <span class="st">"permits"</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Where clause</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>where <span class="op">=</span> <span class="st">"permitissuedate &gt;= '2022-01-01' AND permitissuedate &lt; '2023-01-01'"</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>where <span class="op">=</span> where <span class="op">+</span> <span class="st">" AND permitdescription='RESIDENTIAL BUILDING PERMIT'"</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Query</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>permits <span class="op">=</span> get_carto_data(table_name, where<span class="op">=</span>where)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove missing</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>not_missing <span class="op">=</span> <span class="op">~</span>permits.geometry.is_empty <span class="op">&amp;</span> permits.geometry.notna()</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>permits <span class="op">=</span> permits.loc[not_missing]</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the X/Y</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>permitsXY <span class="op">=</span> get_xy_from_geometry(permits.to_crs(epsg<span class="op">=</span><span class="dv">3857</span>))</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the k nearest algorithm</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>nbrs <span class="op">=</span> NearestNeighbors(n_neighbors<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>nbrs.fit(permitsXY)</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>permitsDist, _ <span class="op">=</span> nbrs.kneighbors(salesXY)</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the new feature</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>sales[<span class="st">"logDistPermits"</span>] <span class="op">=</span> np.log10(permitsDist.mean(axis<span class="op">=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/49/ntrr94q12xd4rq8hqdnx96gm0000gn/T/ipykernel_17229/3972340687.py:12: UserWarning: GeoSeries.notna() previously returned False for both missing (None) and empty geometries. Now, it only returns False for missing values. Since the calling GeoSeries contains empty geometries, the result has changed compared to previous versions of GeoPandas.
Given a GeoSeries 's', you can use '~s.is_empty &amp; s.notna()' to get back the old behaviour.

To further ignore this warning, you can do: 
import warnings; warnings.filterwarnings('ignore', 'GeoSeries.notna', UserWarning)
  not_missing = ~permits.geometry.is_empty &amp; permits.geometry.notna()</code></pre>
</div>
</div>
<div class="cell" data-tags="[]" data-execution_count="70">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>), facecolor<span class="op">=</span>plt.get_cmap(<span class="st">"viridis"</span>)(<span class="dv">0</span>))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> salesXY[:, <span class="dv">0</span>]</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> salesXY[:, <span class="dv">1</span>]</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>ax.hexbin(x, y, C<span class="op">=</span>np.log10(permitsDist.mean(axis<span class="op">=</span><span class="dv">1</span>)), gridsize<span class="op">=</span><span class="dv">60</span>)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the city limits</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>city_limits.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">"none"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>, linewidth<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>ax.set_aspect(<span class="st">"equal"</span>)</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Distance to 5 Closest Building Permits"</span>, fontsize<span class="op">=</span><span class="dv">16</span>, color<span class="op">=</span><span class="st">"white"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lecture-13B_files/figure-html/cell-33-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="aggravated-assaults" class="level3">
<h3 class="anchored" data-anchor-id="aggravated-assaults">5. Aggravated Assaults</h3>
<p>New feature: Distance to the 5 nearest aggravated assaults in 2022</p>
<ul>
<li>Source: <a href="https://www.opendataphilly.org/dataset/crime-incidents">OpenDataPhilly</a></li>
<li>CARTO table name: “incidents_part1_part2”</li>
</ul>
<p><strong>Notes</strong></p>
<ul>
<li>You can pull aggravated assaults only by selecting where <code>Text_General_Code</code> equals ‘Aggravated Assault No Firearm’ or ‘Aggravated Assault Firearm’</li>
<li>You can select crimes from only 2022 using the <code>dispatch_date</code> column</li>
</ul>
<div class="cell" data-tags="[]" data-execution_count="71">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Table name</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>table_name <span class="op">=</span> <span class="st">"incidents_part1_part2"</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Where selection</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>where <span class="op">=</span> <span class="st">"dispatch_date &gt;= '2022-01-01' AND dispatch_date &lt; '2023-01-01'"</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>where <span class="op">=</span> where <span class="op">+</span> <span class="st">" AND Text_General_Code IN ('Aggravated Assault No Firearm', 'Aggravated Assault Firearm')"</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Query</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>assaults <span class="op">=</span> get_carto_data(table_name, where<span class="op">=</span>where)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove missing </span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>not_missing <span class="op">=</span> <span class="op">~</span>assaults.geometry.is_empty <span class="op">&amp;</span> assaults.geometry.notna()</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>assaults <span class="op">=</span> assaults.loc[not_missing]</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the X/Y</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>assaultsXY <span class="op">=</span> get_xy_from_geometry(assaults.to_crs(epsg<span class="op">=</span><span class="dv">3857</span>))</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the k nearest algorithm</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>nbrs <span class="op">=</span> NearestNeighbors(n_neighbors<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>nbrs.fit(assaultsXY)</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>assaultDists, _ <span class="op">=</span> nbrs.kneighbors(salesXY)</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the new feature</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>sales[<span class="st">'logDistAssaults'</span>] <span class="op">=</span> np.log10(assaultDists.mean(axis<span class="op">=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="72">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>), facecolor<span class="op">=</span>plt.get_cmap(<span class="st">"viridis"</span>)(<span class="dv">0</span>))</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> salesXY[:, <span class="dv">0</span>]</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> salesXY[:, <span class="dv">1</span>]</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>ax.hexbin(x, y, C<span class="op">=</span>np.log10(assaultDists.mean(axis<span class="op">=</span><span class="dv">1</span>)), gridsize<span class="op">=</span><span class="dv">60</span>)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the city limits</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>city_limits.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">"none"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>, linewidth<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>ax.set_aspect(<span class="st">"equal"</span>)</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Distance to 5 Closest Assaults"</span>, fontsize<span class="op">=</span><span class="dv">16</span>, color<span class="op">=</span><span class="st">"white"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lecture-13B_files/figure-html/cell-35-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="abandonded-vehicle-311-calls" class="level3">
<h3 class="anchored" data-anchor-id="abandonded-vehicle-311-calls">6. Abandonded Vehicle 311 Calls</h3>
<p>New feature: Distance to the 5 nearest abandoned vehicle 311 calls in 2022</p>
<ul>
<li>Source: <a href="https://www.opendataphilly.org/dataset/311-service-and-information-requests">OpenDataPhilly</a></li>
<li>CARTO table name: “public_cases_fc”</li>
</ul>
<p><strong>Notes</strong></p>
<ul>
<li>You can pull abandonded vehicle calls only by selecting where <code>service_name</code> equals ‘Abandoned Vehicle’</li>
<li>You can select crimes from only 2022 using the <code>requested_datetime</code> column</li>
</ul>
<div class="cell" data-tags="[]" data-execution_count="73">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Table name</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>table_name <span class="op">=</span> <span class="st">"public_cases_fc"</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Where selection</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>where <span class="op">=</span> <span class="st">"requested_datetime &gt;= '2022-01-01' AND requested_datetime &lt; '2023-01-01'"</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>where <span class="op">=</span> <span class="st">"service_name = 'Abandoned Vehicle'"</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Query</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>cars <span class="op">=</span> get_carto_data(table_name, where<span class="op">=</span>where)</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove missing</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>not_missing <span class="op">=</span> <span class="op">~</span>cars.geometry.is_empty <span class="op">&amp;</span> cars.geometry.notna()</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>cars <span class="op">=</span> cars.loc[not_missing]</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the X/Y</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>carsXY <span class="op">=</span> get_xy_from_geometry(cars.to_crs(epsg<span class="op">=</span><span class="dv">3857</span>))</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the k nearest algorithm</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>nbrs <span class="op">=</span> NearestNeighbors(n_neighbors<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>nbrs.fit(carsXY)</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>carDists, _ <span class="op">=</span> nbrs.kneighbors(salesXY)</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Handle any sales that have 0 distances</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>carDists[carDists <span class="op">==</span> <span class="dv">0</span>] <span class="op">=</span> <span class="fl">1e-5</span>  <span class="co"># a small, arbitrary value</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the new feature</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>sales[<span class="st">"logDistCars"</span>] <span class="op">=</span> np.log10(carDists.mean(axis<span class="op">=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="74">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>), facecolor<span class="op">=</span>plt.get_cmap(<span class="st">"viridis"</span>)(<span class="dv">0</span>))</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> salesXY[:, <span class="dv">0</span>]</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> salesXY[:, <span class="dv">1</span>]</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>ax.hexbin(x, y, C<span class="op">=</span>np.log10(carDists.mean(axis<span class="op">=</span><span class="dv">1</span>)), gridsize<span class="op">=</span><span class="dv">60</span>)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the city limits</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>city_limits.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">"none"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>, linewidth<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>ax.set_aspect(<span class="st">"equal"</span>)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>ax.set_title(</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Distance to 5 Closest Abandoned Vehichle 311 Calls"</span>, fontsize<span class="op">=</span><span class="dv">16</span>, color<span class="op">=</span><span class="st">"white"</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lecture-13B_files/figure-html/cell-37-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="fit-the-updated-model" class="level2">
<h2 class="anchored" data-anchor-id="fit-the-updated-model">Fit the updated model</h2>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="75">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Numerical columns</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>num_cols <span class="op">=</span> [</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_livable_area"</span>,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_area"</span>,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"garage_spaces"</span>,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fireplaces"</span>,</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"number_of_bathrooms"</span>,</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"number_of_bedrooms"</span>,</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"number_stories"</span>,</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"logDistGraffiti"</span>, <span class="co"># NEW</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"logDistSubway"</span>, <span class="co"># NEW</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"logDistUniv"</span>, <span class="co"># NEW</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"logDistParks"</span>, <span class="co"># NEW</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"logDistCityHall"</span>, <span class="co"># NEW </span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"logDistPermits"</span>, <span class="co"># NEW</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"logDistAssaults"</span>, <span class="co"># NEW</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"logDistCars"</span> <span class="co"># NEW</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Categorical columns</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>cat_cols <span class="op">=</span> [<span class="st">"exterior_condition"</span>, <span class="st">"zip_code"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="76">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up the column transformer with two transformers</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>transformer <span class="op">=</span> ColumnTransformer(</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    transformers<span class="op">=</span>[</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"num"</span>, StandardScaler(), num_cols),</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"cat"</span>, OneHotEncoder(handle_unknown<span class="op">=</span><span class="st">"ignore"</span>), cat_cols),</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="77">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Two steps in pipeline: preprocessor and then regressor</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> make_pipeline(</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    transformer, RandomForestRegressor(n_estimators<span class="op">=</span><span class="dv">20</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="78">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Split the data 70/30</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>train_set, test_set <span class="op">=</span> train_test_split(sales, test_size<span class="op">=</span><span class="fl">0.3</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># the target labels</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> np.log(train_set[<span class="st">"sale_price"</span>])</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> np.log(test_set[<span class="st">"sale_price"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="79">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the training set</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>pipe.fit(train_set, y_train)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="80">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># What's the test score?</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>pipe.score(test_set, y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="80">
<pre><code>0.6201555163668022</code></pre>
</div>
</div>
<section id="more-improvement" class="level3">
<h3 class="anchored" data-anchor-id="more-improvement">More improvement!</h3>
</section>
<section id="feature-importances" class="level3">
<h3 class="anchored" data-anchor-id="feature-importances">Feature importances:</h3>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="82">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The one-hot step</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>ohe <span class="op">=</span> transformer.named_transformers_[<span class="st">"cat"</span>]</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># One column for each category type!</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>ohe_cols <span class="op">=</span> ohe.get_feature_names_out()</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Full list of columns is numerical + one-hot</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>features <span class="op">=</span> num_cols <span class="op">+</span> <span class="bu">list</span>(ohe_cols)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="co"># The regressor</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>regressor <span class="op">=</span> pipe[<span class="st">"randomforestregressor"</span>]</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the dataframe with importances</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>importance <span class="op">=</span> pd.DataFrame(</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"Feature"</span>: features, <span class="st">"Importance"</span>: regressor.feature_importances_}</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort importance in descending order and get the top</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>importance <span class="op">=</span> importance.sort_values(<span class="st">"Importance"</span>, ascending<span class="op">=</span><span class="va">False</span>).iloc[:<span class="dv">30</span>]</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>importance.hvplot.barh(</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"Feature"</span>, y<span class="op">=</span><span class="st">"Importance"</span>, flip_yaxis<span class="op">=</span><span class="va">True</span>, height<span class="op">=</span><span class="dv">500</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="82">
<div id="p1060">
  <div id="f0c03e12-b45c-4a18-8445-5f9f38500f34" data-root-id="p1060" style="display: contents;"></div>
</div>
<script type="application/javascript">(function(root) {
  var docs_json = {"d5880395-aabf-46e7-a6e0-0920c12473cf":{"version":"3.2.1","title":"Bokeh Application","roots":[{"type":"object","name":"Row","id":"p1060","attributes":{"name":"Row01034","tags":["embedded"],"stylesheets":["\n:host(.pn-loading.pn-arc):before, .pn-loading.pn-arc:before {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHN0eWxlPSJtYXJnaW46IGF1dG87IGJhY2tncm91bmQ6IG5vbmU7IGRpc3BsYXk6IGJsb2NrOyBzaGFwZS1yZW5kZXJpbmc6IGF1dG87IiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQiPiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjYzNjM2MzIiBzdHJva2Utd2lkdGg9IjEwIiByPSIzNSIgc3Ryb2tlLWRhc2hhcnJheT0iMTY0LjkzMzYxNDMxMzQ2NDE1IDU2Ljk3Nzg3MTQzNzgyMTM4Ij4gICAgPGFuaW1hdGVUcmFuc2Zvcm0gYXR0cmlidXRlTmFtZT0idHJhbnNmb3JtIiB0eXBlPSJyb3RhdGUiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBkdXI9IjFzIiB2YWx1ZXM9IjAgNTAgNTA7MzYwIDUwIDUwIiBrZXlUaW1lcz0iMDsxIj48L2FuaW1hdGVUcmFuc2Zvcm0+ICA8L2NpcmNsZT48L3N2Zz4=\");\n  background-size: auto calc(min(50%, 400px));\n}",{"type":"object","name":"ImportedStyleSheet","id":"p1063","attributes":{"url":"https://cdn.holoviz.org/panel/1.2.1/dist/css/loading.css"}},{"type":"object","name":"ImportedStyleSheet","id":"p1115","attributes":{"url":"https://cdn.holoviz.org/panel/1.2.1/dist/css/listpanel.css"}},{"type":"object","name":"ImportedStyleSheet","id":"p1061","attributes":{"url":"https://cdn.holoviz.org/panel/1.2.1/dist/bundled/theme/default.css"}},{"type":"object","name":"ImportedStyleSheet","id":"p1062","attributes":{"url":"https://cdn.holoviz.org/panel/1.2.1/dist/bundled/theme/native.css"}}],"min_width":700,"margin":0,"sizing_mode":"stretch_width","align":"start","children":[{"type":"object","name":"Spacer","id":"p1064","attributes":{"name":"HSpacer01045","stylesheets":["\n:host(.pn-loading.pn-arc):before, .pn-loading.pn-arc:before {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHN0eWxlPSJtYXJnaW46IGF1dG87IGJhY2tncm91bmQ6IG5vbmU7IGRpc3BsYXk6IGJsb2NrOyBzaGFwZS1yZW5kZXJpbmc6IGF1dG87IiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQiPiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjYzNjM2MzIiBzdHJva2Utd2lkdGg9IjEwIiByPSIzNSIgc3Ryb2tlLWRhc2hhcnJheT0iMTY0LjkzMzYxNDMxMzQ2NDE1IDU2Ljk3Nzg3MTQzNzgyMTM4Ij4gICAgPGFuaW1hdGVUcmFuc2Zvcm0gYXR0cmlidXRlTmFtZT0idHJhbnNmb3JtIiB0eXBlPSJyb3RhdGUiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBkdXI9IjFzIiB2YWx1ZXM9IjAgNTAgNTA7MzYwIDUwIDUwIiBrZXlUaW1lcz0iMDsxIj48L2FuaW1hdGVUcmFuc2Zvcm0+ICA8L2NpcmNsZT48L3N2Zz4=\");\n  background-size: auto calc(min(50%, 400px));\n}",{"id":"p1063"},{"id":"p1061"},{"id":"p1062"}],"margin":0,"sizing_mode":"stretch_width","align":"start"}},{"type":"object","name":"Figure","id":"p1072","attributes":{"width":700,"height":500,"margin":[5,10],"sizing_mode":"fixed","align":"start","x_range":{"type":"object","name":"Range1d","id":"p1065","attributes":{"tags":[[["Importance","Importance",null]],[]],"end":0.2779982657447395,"reset_start":0.0,"reset_end":0.2779982657447395}},"y_range":{"type":"object","name":"FactorRange","id":"p1066","attributes":{"tags":[[["Feature","Feature",null]],{"type":"map","entries":[["invert_yaxis",true],["autorange",false]]}],"factors":["zip_code_19143","zip_code_19145","zip_code_19131","zip_code_19133","zip_code_19132","zip_code_19142","exterior_condition_3","zip_code_19134","exterior_condition_6","garage_spaces","exterior_condition_2","zip_code_19140","number_stories","zip_code_19104","exterior_condition_4","number_of_bedrooms","exterior_condition_5","exterior_condition_7","zip_code_19125","logDistCars","logDistGraffiti","logDistParks","number_of_bathrooms","logDistPermits","logDistUniv","logDistSubway","total_area","total_livable_area","logDistCityHall","logDistAssaults"]}},"x_scale":{"type":"object","name":"LinearScale","id":"p1082"},"y_scale":{"type":"object","name":"CategoricalScale","id":"p1083"},"title":{"type":"object","name":"Title","id":"p1075","attributes":{"text_color":"black","text_font_size":"12pt"}},"renderers":[{"type":"object","name":"GlyphRenderer","id":"p1108","attributes":{"data_source":{"type":"object","name":"ColumnDataSource","id":"p1099","attributes":{"selected":{"type":"object","name":"Selection","id":"p1100","attributes":{"indices":[],"line_indices":[]}},"selection_policy":{"type":"object","name":"UnionRenderers","id":"p1101"},"data":{"type":"map","entries":[["Feature",["logDistAssaults","logDistCityHall","total_livable_area","total_area","logDistSubway","logDistUniv","logDistPermits","number_of_bathrooms","logDistParks","logDistGraffiti","logDistCars","zip_code_19125","exterior_condition_7","exterior_condition_5","number_of_bedrooms","exterior_condition_4","zip_code_19104","number_stories","zip_code_19140","exterior_condition_2","garage_spaces","exterior_condition_6","zip_code_19134","exterior_condition_3","zip_code_19142","zip_code_19132","zip_code_19133","zip_code_19131","zip_code_19145","zip_code_19143"]],["Importance",{"type":"ndarray","array":{"type":"bytes","data":"j7QUwkAu0D+/Yodu5tvIPz1BqFEblcA/+sYcv63Rtj8tM61GNs2lP15204PrmqI/pg4ODe5+oj/raY/19t6hPwdYekZuvqE/tVZwH5eEoT8l2TaBufeePzr1Fsab6YQ/q2vmpN96gD8ukerVWDp6P43NRFfH8XM/iuB+ojepcT9hcWYycW1wP3oG8scOD3A/7WP2AUqBbz+NKyCgTVNvP4Cdbl4pHG4/Nq1YJM36aT/iwaY0ymRiP4/R/QF7BGI/ANpScPUcYT+uiO1FMZ9gP3UgzbaxsV0/Z7JGk2+UVD8KHM2ATBBSP5DX/5f1i1E/"},"shape":[30],"dtype":"float64","order":"little"}]]}}},"view":{"type":"object","name":"CDSView","id":"p1109","attributes":{"filter":{"type":"object","name":"AllIndices","id":"p1110"}}},"glyph":{"type":"object","name":"HBar","id":"p1105","attributes":{"tags":["apply_ranges"],"y":{"type":"field","field":"Feature"},"height":{"type":"value","value":0.8},"right":{"type":"field","field":"Importance"},"fill_color":{"type":"value","value":"#30a2da"},"hatch_color":{"type":"value","value":"#30a2da"}}},"selection_glyph":{"type":"object","name":"HBar","id":"p1111","attributes":{"tags":["apply_ranges"],"y":{"type":"field","field":"Feature"},"height":{"type":"value","value":0.8},"left":{"type":"value","value":0},"right":{"type":"field","field":"Importance"},"line_color":{"type":"value","value":"black"},"line_alpha":{"type":"value","value":1.0},"line_width":{"type":"value","value":1},"line_join":{"type":"value","value":"bevel"},"line_cap":{"type":"value","value":"butt"},"line_dash":{"type":"value","value":[]},"line_dash_offset":{"type":"value","value":0},"fill_color":{"type":"value","value":"#30a2da"},"fill_alpha":{"type":"value","value":1.0},"hatch_color":{"type":"value","value":"#30a2da"},"hatch_alpha":{"type":"value","value":1.0},"hatch_scale":{"type":"value","value":12.0},"hatch_pattern":{"type":"value","value":null},"hatch_weight":{"type":"value","value":1.0}}},"nonselection_glyph":{"type":"object","name":"HBar","id":"p1106","attributes":{"tags":["apply_ranges"],"y":{"type":"field","field":"Feature"},"height":{"type":"value","value":0.8},"right":{"type":"field","field":"Importance"},"line_alpha":{"type":"value","value":0.1},"fill_color":{"type":"value","value":"#30a2da"},"fill_alpha":{"type":"value","value":0.1},"hatch_color":{"type":"value","value":"#30a2da"},"hatch_alpha":{"type":"value","value":0.1}}},"muted_glyph":{"type":"object","name":"HBar","id":"p1107","attributes":{"tags":["apply_ranges"],"y":{"type":"field","field":"Feature"},"height":{"type":"value","value":0.8},"right":{"type":"field","field":"Importance"},"line_alpha":{"type":"value","value":0.2},"fill_color":{"type":"value","value":"#30a2da"},"fill_alpha":{"type":"value","value":0.2},"hatch_color":{"type":"value","value":"#30a2da"},"hatch_alpha":{"type":"value","value":0.2}}}}}],"toolbar":{"type":"object","name":"Toolbar","id":"p1081","attributes":{"tools":[{"type":"object","name":"WheelZoomTool","id":"p1070","attributes":{"tags":["hv_created"],"zoom_together":"none"}},{"type":"object","name":"HoverTool","id":"p1071","attributes":{"tags":["hv_created"],"renderers":[{"id":"p1108"}],"tooltips":[["Feature","@{Feature}"],["Importance","@{Importance}"]]}},{"type":"object","name":"SaveTool","id":"p1094"},{"type":"object","name":"PanTool","id":"p1095"},{"type":"object","name":"BoxZoomTool","id":"p1096","attributes":{"overlay":{"type":"object","name":"BoxAnnotation","id":"p1097","attributes":{"syncable":false,"level":"overlay","visible":false,"left_units":"canvas","right_units":"canvas","bottom_units":"canvas","top_units":"canvas","line_color":"black","line_alpha":1.0,"line_width":2,"line_dash":[4,4],"fill_color":"lightgrey","fill_alpha":0.5}}}},{"type":"object","name":"ResetTool","id":"p1098"}],"active_drag":{"id":"p1095"},"active_scroll":{"id":"p1070"}}},"left":[{"type":"object","name":"CategoricalAxis","id":"p1089","attributes":{"ticker":{"type":"object","name":"CategoricalTicker","id":"p1090"},"formatter":{"type":"object","name":"CategoricalTickFormatter","id":"p1091"},"axis_label":"Feature","major_label_policy":{"type":"object","name":"AllLabels","id":"p1092"}}}],"below":[{"type":"object","name":"LinearAxis","id":"p1084","attributes":{"ticker":{"type":"object","name":"BasicTicker","id":"p1085","attributes":{"mantissas":[1,2,5]}},"formatter":{"type":"object","name":"BasicTickFormatter","id":"p1086"},"axis_label":"Importance","major_label_policy":{"type":"object","name":"AllLabels","id":"p1087"}}}],"center":[{"type":"object","name":"Grid","id":"p1088","attributes":{"axis":{"id":"p1084"},"grid_line_color":null}},{"type":"object","name":"Grid","id":"p1093","attributes":{"dimension":1,"axis":{"id":"p1089"},"grid_line_color":null}}],"min_border_top":10,"min_border_bottom":10,"min_border_left":10,"min_border_right":10,"output_backend":"webgl"}},{"type":"object","name":"Spacer","id":"p1113","attributes":{"name":"HSpacer01048","stylesheets":["\n:host(.pn-loading.pn-arc):before, .pn-loading.pn-arc:before {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHN0eWxlPSJtYXJnaW46IGF1dG87IGJhY2tncm91bmQ6IG5vbmU7IGRpc3BsYXk6IGJsb2NrOyBzaGFwZS1yZW5kZXJpbmc6IGF1dG87IiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQiPiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjYzNjM2MzIiBzdHJva2Utd2lkdGg9IjEwIiByPSIzNSIgc3Ryb2tlLWRhc2hhcnJheT0iMTY0LjkzMzYxNDMxMzQ2NDE1IDU2Ljk3Nzg3MTQzNzgyMTM4Ij4gICAgPGFuaW1hdGVUcmFuc2Zvcm0gYXR0cmlidXRlTmFtZT0idHJhbnNmb3JtIiB0eXBlPSJyb3RhdGUiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBkdXI9IjFzIiB2YWx1ZXM9IjAgNTAgNTA7MzYwIDUwIDUwIiBrZXlUaW1lcz0iMDsxIj48L2FuaW1hdGVUcmFuc2Zvcm0+ICA8L2NpcmNsZT48L3N2Zz4=\");\n  background-size: auto calc(min(50%, 400px));\n}",{"id":"p1063"},{"id":"p1061"},{"id":"p1062"}],"margin":0,"sizing_mode":"stretch_width","align":"start"}}]}}],"defs":[{"type":"model","name":"ReactiveHTML1"},{"type":"model","name":"FlexBox1","properties":[{"name":"align_content","kind":"Any","default":"flex-start"},{"name":"align_items","kind":"Any","default":"flex-start"},{"name":"flex_direction","kind":"Any","default":"row"},{"name":"flex_wrap","kind":"Any","default":"wrap"},{"name":"justify_content","kind":"Any","default":"flex-start"}]},{"type":"model","name":"FloatPanel1","properties":[{"name":"config","kind":"Any","default":{"type":"map"}},{"name":"contained","kind":"Any","default":true},{"name":"position","kind":"Any","default":"right-top"},{"name":"offsetx","kind":"Any","default":null},{"name":"offsety","kind":"Any","default":null},{"name":"theme","kind":"Any","default":"primary"},{"name":"status","kind":"Any","default":"normalized"}]},{"type":"model","name":"GridStack1","properties":[{"name":"mode","kind":"Any","default":"warn"},{"name":"ncols","kind":"Any","default":null},{"name":"nrows","kind":"Any","default":null},{"name":"allow_resize","kind":"Any","default":true},{"name":"allow_drag","kind":"Any","default":true},{"name":"state","kind":"Any","default":[]}]},{"type":"model","name":"drag1","properties":[{"name":"slider_width","kind":"Any","default":5},{"name":"slider_color","kind":"Any","default":"black"},{"name":"value","kind":"Any","default":50}]},{"type":"model","name":"click1","properties":[{"name":"terminal_output","kind":"Any","default":""},{"name":"debug_name","kind":"Any","default":""},{"name":"clears","kind":"Any","default":0}]},{"type":"model","name":"FastWrapper1","properties":[{"name":"object","kind":"Any","default":null},{"name":"style","kind":"Any","default":null}]},{"type":"model","name":"NotificationAreaBase1","properties":[{"name":"js_events","kind":"Any","default":{"type":"map"}},{"name":"position","kind":"Any","default":"bottom-right"},{"name":"_clear","kind":"Any","default":0}]},{"type":"model","name":"NotificationArea1","properties":[{"name":"js_events","kind":"Any","default":{"type":"map"}},{"name":"notifications","kind":"Any","default":[]},{"name":"position","kind":"Any","default":"bottom-right"},{"name":"_clear","kind":"Any","default":0},{"name":"types","kind":"Any","default":[{"type":"map","entries":[["type","warning"],["background","#ffc107"],["icon",{"type":"map","entries":[["className","fas fa-exclamation-triangle"],["tagName","i"],["color","white"]]}]]},{"type":"map","entries":[["type","info"],["background","#007bff"],["icon",{"type":"map","entries":[["className","fas fa-info-circle"],["tagName","i"],["color","white"]]}]]}]}]},{"type":"model","name":"Notification","properties":[{"name":"background","kind":"Any","default":null},{"name":"duration","kind":"Any","default":3000},{"name":"icon","kind":"Any","default":null},{"name":"message","kind":"Any","default":""},{"name":"notification_type","kind":"Any","default":null},{"name":"_destroyed","kind":"Any","default":false}]},{"type":"model","name":"TemplateActions1","properties":[{"name":"open_modal","kind":"Any","default":0},{"name":"close_modal","kind":"Any","default":0}]},{"type":"model","name":"BootstrapTemplateActions1","properties":[{"name":"open_modal","kind":"Any","default":0},{"name":"close_modal","kind":"Any","default":0}]},{"type":"model","name":"MaterialTemplateActions1","properties":[{"name":"open_modal","kind":"Any","default":0},{"name":"close_modal","kind":"Any","default":0}]}]}};
  var render_items = [{"docid":"d5880395-aabf-46e7-a6e0-0920c12473cf","roots":{"p1060":"f0c03e12-b45c-4a18-8445-5f9f38500f34"},"root_ids":["p1060"]}];
  var docs = Object.values(docs_json)
  if (!docs) {
    return
  }
  const py_version = docs[0].version.replace('rc', '-rc.').replace('.dev', '-dev.')
  const is_dev = py_version.indexOf("+") !== -1 || py_version.indexOf("-") !== -1
  function embed_document(root) {
    var Bokeh = get_bokeh(root)
    Bokeh.embed.embed_items_notebook(docs_json, render_items);
    for (const render_item of render_items) {
      for (const root_id of render_item.root_ids) {
    const id_el = document.getElementById(root_id)
    if (id_el.children.length && (id_el.children[0].className === 'bk-root')) {
      const root_el = id_el.children[0]
      root_el.id = root_el.id + '-rendered'
    }
      }
    }
  }
  function get_bokeh(root) {
    if (root.Bokeh === undefined) {
      return null
    } else if (root.Bokeh.version !== py_version && !is_dev) {
      if (root.Bokeh.versions === undefined || !root.Bokeh.versions.has(py_version)) {
    return null
      }
      return root.Bokeh.versions.get(py_version);
    } else if (root.Bokeh.version === py_version) {
      return root.Bokeh
    }
    return null
  }
  function is_loaded(root) {
    var Bokeh = get_bokeh(root)
    return (Bokeh != null && Bokeh.Panel !== undefined)
  }
  if (is_loaded(root)) {
    embed_document(root);
  } else {
    var attempts = 0;
    var timer = setInterval(function(root) {
      if (is_loaded(root)) {
        clearInterval(timer);
        embed_document(root);
      } else if (document.readyState == "complete") {
        attempts++;
        if (attempts > 200) {
          clearInterval(timer);
      var Bokeh = get_bokeh(root)
      if (Bokeh == null || Bokeh.Panel == null) {
            console.warn("Panel: ERROR: Unable to run Panel code because Bokeh or Panel library is missing");
      } else {
        console.warn("Panel: WARNING: Attempting to render but not all required libraries could be resolved.")
        embed_document(root)
      }
        }
      }
    }, 25, root)
  }
})(window);</script>
</div>
</div>
</section>
</section>
<section id="part-2-predicting-bikeshare-demand-in-philadelphia" class="level2">
<h2 class="anchored" data-anchor-id="part-2-predicting-bikeshare-demand-in-philadelphia">Part 2: Predicting bikeshare demand in Philadelphia</h2>
<p><strong>The technical problem</strong>: predict bikeshare trip counts for the Indego bikeshare in Philadelphia</p>
<section id="the-policy-question-how-to-best-expand-a-bikeshare-program" class="level3">
<h3 class="anchored" data-anchor-id="the-policy-question-how-to-best-expand-a-bikeshare-program">The policy question: how to best expand a bikeshare program?</h3>
<ul>
<li>Bikeshares typically require substantial capital when first launching, about \$4,000 to \$5,000 per bike</li>
<li>Once launched, revenue from riders typically covers about 80 percent of operating costs</li>
<li>Ridership peaks in busy downtown hubs, but how to best expand outwards, often to low-density and low-income communities?</li>
<li>Important cost/benefit questions of how/where to expand to maximize ridership and access and minimize the need for outside subsidies</li>
</ul>
<p>For more info, see <a href="https://www.pewtrusts.org/en/research-and-analysis/blogs/stateline/2016/03/24/despite-popularity-bike-share-programs-often-need-subsidies">this blog post</a> from Pew</p>
</section>
<section id="using-predictive-modeling-as-a-policy-tool" class="level3">
<h3 class="anchored" data-anchor-id="using-predictive-modeling-as-a-policy-tool">Using predictive modeling as a policy tool</h3>
<ul>
<li>Construct a predictive model for trip counts by stations in a bikeshare</li>
<li>Use this model to estimate and map out the ridership for potential stations in new areas</li>
<li>Use the cost per ride to estimate the additional revenue added</li>
<li>Compare this additional revenue to the cost of adding new stations</li>
</ul>
</section>
<section id="what-are-the-key-assumptions-here" class="level3">
<h3 class="anchored" data-anchor-id="what-are-the-key-assumptions-here">What are the key assumptions here?</h3>
<p><strong>Most important:</strong> adding new stations in new areas will not affect the demand for existing stations.</p>
<p>This allows the results from the predictive model for demand, built on existing stations, to translate to new stations.</p>
<p>The key assumption is that the bikeshare is not yet at full capacity, and riders in new areas will not decrease the demand in other areas.</p>
</section>
<section id="is-this-a-good-assumption" class="level3">
<h3 class="anchored" data-anchor-id="is-this-a-good-assumption">Is this a good assumption?</h3>
<ul>
<li>Given that the bikeshare is looking to expand, it’s a safe bet that they believe the program is not yet at full capacity</li>
<li>This is verifiable with existing data — examine trip counts in neighboring stations when a new station opens up.</li>
</ul>
<p><strong>Typically, this is a pretty safe assumption.</strong> But I encourage you to use historical data to verify it!</p>
</section>
<section id="getting-trip-data-for-the-indego-bike-share" class="level3">
<h3 class="anchored" data-anchor-id="getting-trip-data-for-the-indego-bike-share">Getting trip data for the Indego bike share</h3>
<ul>
<li>Available by quarter from: <a href="https://www.rideindego.com/about/data/">https://www.rideindego.com/about/data/</a></li>
<li>I’ve pulled historic trip data from 2018 through 2023 and combined into a single CSV file (available in the data folder)</li>
</ul>
<p>The data page also includes the live status of all of the stations in the system.</p>
<p>API endpoint: <a href="http://www.rideindego.com/stations/json">http://www.rideindego.com/stations/json</a></p>
<p><strong>Two important columns:</strong></p>
<ul>
<li><code>totalDocks</code>: the total number of docks at each station</li>
<li><code>kioskId</code>: the unique identifier for each station</li>
</ul>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;fragment&quot;}" data-execution_count="90">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># API endpoint</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>API_endpoint <span class="op">=</span> <span class="st">"http://www.rideindego.com/stations/json"</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the JSON</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>stations_geojson <span class="op">=</span> requests.get(API_endpoint).json()</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to a GeoDataFrame</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>stations <span class="op">=</span> gpd.GeoDataFrame.from_features(stations_geojson, crs<span class="op">=</span><span class="st">"EPSG:4326"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="91">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>stations.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="91">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">coordinates</th>
<th data-quarto-table-cell-role="th">totalDocks</th>
<th data-quarto-table-cell-role="th">docksAvailable</th>
<th data-quarto-table-cell-role="th">bikesAvailable</th>
<th data-quarto-table-cell-role="th">classicBikesAvailable</th>
<th data-quarto-table-cell-role="th">smartBikesAvailable</th>
<th data-quarto-table-cell-role="th">electricBikesAvailable</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">isEventBased</th>
<th data-quarto-table-cell-role="th">isVirtual</th>
<th data-quarto-table-cell-role="th">kioskId</th>
<th data-quarto-table-cell-role="th">notes</th>
<th data-quarto-table-cell-role="th">openTime</th>
<th data-quarto-table-cell-role="th">publicText</th>
<th data-quarto-table-cell-role="th">timeZone</th>
<th data-quarto-table-cell-role="th">trikesAvailable</th>
<th data-quarto-table-cell-role="th">latitude</th>
<th data-quarto-table-cell-role="th">longitude</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>POINT (-75.14403 39.94733)</td>
<td>3005</td>
<td>Welcome Park, NPS</td>
<td>[-75.14403, 39.94733]</td>
<td>13</td>
<td>10</td>
<td>3</td>
<td>1</td>
<td>0</td>
<td>2</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>3005</td>
<td>None</td>
<td>None</td>
<td></td>
<td>None</td>
<td>0</td>
<td>39.94733</td>
<td>-75.14403</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>POINT (-75.20311 39.95220)</td>
<td>3006</td>
<td>40th &amp; Spruce</td>
<td>[-75.20311, 39.9522]</td>
<td>17</td>
<td>16</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>3006</td>
<td>None</td>
<td>None</td>
<td></td>
<td>None</td>
<td>0</td>
<td>39.95220</td>
<td>-75.20311</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>POINT (-75.15993 39.94517)</td>
<td>3007</td>
<td>11th &amp; Pine, Kahn Park</td>
<td>[-75.15993, 39.94517]</td>
<td>20</td>
<td>13</td>
<td>7</td>
<td>6</td>
<td>0</td>
<td>1</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>3007</td>
<td>None</td>
<td>None</td>
<td></td>
<td>None</td>
<td>0</td>
<td>39.94517</td>
<td>-75.15993</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>POINT (-75.15067 39.98081)</td>
<td>3008</td>
<td>Temple University Station</td>
<td>[-75.15067, 39.98081]</td>
<td>17</td>
<td>6</td>
<td>11</td>
<td>0</td>
<td>0</td>
<td>11</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>3008</td>
<td>None</td>
<td>None</td>
<td></td>
<td>None</td>
<td>0</td>
<td>39.98081</td>
<td>-75.15067</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>POINT (-75.18982 39.95576)</td>
<td>3009</td>
<td>33rd &amp; Market</td>
<td>[-75.18982, 39.95576]</td>
<td>14</td>
<td>10</td>
<td>3</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>3009</td>
<td>None</td>
<td>None</td>
<td></td>
<td>None</td>
<td>0</td>
<td>39.95576</td>
<td>-75.18982</td>
</tr>
</tbody>
</table>

<p>5 rows × 34 columns</p>
</div>
</div>
</div>
</section>
<section id="lets-plot-the-stations-colored-by-the-number-of-docks" class="level3">
<h3 class="anchored" data-anchor-id="lets-plot-the-stations-colored-by-the-number-of-docks">Let’s plot the stations, colored by the number of docks</h3>
<p>Use the <a href="https://contextily.readthedocs.io/en/latest/index.html">contextily</a> package to add a static basemap underneath the matplotlib plot of the stations.</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="92">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> contextily <span class="im">as</span> ctx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="93">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">10</span>))</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co"># stations</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>stations_3857 <span class="op">=</span> stations.to_crs(epsg<span class="op">=</span><span class="dv">3857</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>stations_3857.plot(ax<span class="op">=</span>ax, column<span class="op">=</span><span class="st">'totalDocks'</span>, legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the basemap underneath</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>ctx.add_basemap(ax<span class="op">=</span>ax, crs<span class="op">=</span>stations_3857.crs, source<span class="op">=</span>ctx.providers.CartoDB.DarkMatter)</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>ax.set_axis_off()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lecture-13B_files/figure-html/cell-48-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="load-historic-trips-data" class="level3">
<h3 class="anchored" data-anchor-id="load-historic-trips-data">Load historic trips data</h3>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;fragment&quot;}" data-execution_count="94">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>all_trips <span class="op">=</span> pd.read_csv(<span class="st">"./data/indego-trips-2018-2023.csv.tar.gz"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/49/ntrr94q12xd4rq8hqdnx96gm0000gn/T/ipykernel_17229/751211994.py:1: DtypeWarning: Columns (10,14) have mixed types. Specify dtype option on import or set low_memory=False.
  all_trips = pd.read_csv("./data/indego-trips-2018-2023.csv.tar.gz")</code></pre>
</div>
</div>
<div class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'start_time'</span>, <span class="st">'end_time'</span>]:</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    all_trips[col] <span class="op">=</span> pd.to_datetime(all_trips[col], <span class="bu">format</span><span class="op">=</span><span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(all_trips)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="96">
<pre><code>3898067</code></pre>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="97">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>all_trips.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="97">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">trip_id</th>
<th data-quarto-table-cell-role="th">duration</th>
<th data-quarto-table-cell-role="th">start_time</th>
<th data-quarto-table-cell-role="th">end_time</th>
<th data-quarto-table-cell-role="th">start_station</th>
<th data-quarto-table-cell-role="th">start_lat</th>
<th data-quarto-table-cell-role="th">start_lon</th>
<th data-quarto-table-cell-role="th">end_station</th>
<th data-quarto-table-cell-role="th">end_lat</th>
<th data-quarto-table-cell-role="th">end_lon</th>
<th data-quarto-table-cell-role="th">bike_id</th>
<th data-quarto-table-cell-role="th">plan_duration</th>
<th data-quarto-table-cell-role="th">trip_route_category</th>
<th data-quarto-table-cell-role="th">passholder_type</th>
<th data-quarto-table-cell-role="th">bike_type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>223869188</td>
<td>18</td>
<td>2018-01-01 00:24:00</td>
<td>2018-01-01 00:42:00</td>
<td>3124</td>
<td>39.952950</td>
<td>-75.139793</td>
<td>3073</td>
<td>39.961430</td>
<td>-75.152420</td>
<td>3708</td>
<td>30.0</td>
<td>One Way</td>
<td>Indego30</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>223872811</td>
<td>22</td>
<td>2018-01-01 00:48:00</td>
<td>2018-01-01 01:10:00</td>
<td>3026</td>
<td>39.941380</td>
<td>-75.145638</td>
<td>3023</td>
<td>39.950481</td>
<td>-75.172859</td>
<td>11735</td>
<td>30.0</td>
<td>One Way</td>
<td>Indego30</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>223872810</td>
<td>21</td>
<td>2018-01-01 01:03:00</td>
<td>2018-01-01 01:24:00</td>
<td>3045</td>
<td>39.947922</td>
<td>-75.162369</td>
<td>3037</td>
<td>39.954239</td>
<td>-75.161377</td>
<td>5202</td>
<td>30.0</td>
<td>One Way</td>
<td>Indego30</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>223872809</td>
<td>4</td>
<td>2018-01-01 01:05:00</td>
<td>2018-01-01 01:09:00</td>
<td>3115</td>
<td>39.972630</td>
<td>-75.167572</td>
<td>3058</td>
<td>39.967159</td>
<td>-75.170013</td>
<td>5142</td>
<td>30.0</td>
<td>One Way</td>
<td>Indego30</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>223912960</td>
<td>658</td>
<td>2018-01-01 01:14:00</td>
<td>2018-01-01 12:12:00</td>
<td>3045</td>
<td>39.947922</td>
<td>-75.162369</td>
<td>3000</td>
<td>NaN</td>
<td>NaN</td>
<td>5196</td>
<td>30.0</td>
<td>One Way</td>
<td>Indego30</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="dependent-variable-total-trips-by-starting-station" class="level3">
<h3 class="anchored" data-anchor-id="dependent-variable-total-trips-by-starting-station">Dependent variable: total trips by starting station</h3>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="98">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>start_trips <span class="op">=</span> (</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    all_trips.groupby(<span class="st">"start_station"</span>).size().reset_index(name<span class="op">=</span><span class="st">"total_start_trips"</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="99">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>start_trips.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="99">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">start_station</th>
<th data-quarto-table-cell-role="th">total_start_trips</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>3000</td>
<td>577</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>3004</td>
<td>26544</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3005</td>
<td>21489</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>3006</td>
<td>35810</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>3007</td>
<td>69165</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="100">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now merge in the geometry for each station</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>bike_data <span class="op">=</span> (</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    stations[[<span class="st">"geometry"</span>, <span class="st">"kioskId"</span>]]</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    .merge(start_trips, left_on<span class="op">=</span><span class="st">"kioskId"</span>, right_on<span class="op">=</span><span class="st">"start_station"</span>)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    .to_crs(epsg<span class="op">=</span><span class="dv">3857</span>)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s plot it…</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="101">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co"># stations</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>bike_data.plot(ax<span class="op">=</span>ax, column<span class="op">=</span><span class="st">'total_start_trips'</span>, legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the basemap underneath</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>ctx.add_basemap(ax<span class="op">=</span>ax, crs<span class="op">=</span>bike_data.crs, source<span class="op">=</span>ctx.providers.CartoDB.DarkMatter)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>ax.set_axis_off()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lecture-13B_files/figure-html/cell-56-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Trips are clearly concentrated in Center City…</p>
</section>
<section id="what-features-to-use" class="level3">
<h3 class="anchored" data-anchor-id="what-features-to-use">What features to use?</h3>
<p>There are lots of possible options. Generally speaking, the possible features fall into a few different categories:</p>
<ul>
<li><strong>Internal</strong>
<ul>
<li>e.g., the number of docks per station</li>
</ul></li>
<li><strong>Demographic (Census)</strong>
<ul>
<li>e.g., population, income, percent commuting by car, percent with bachelor’s degree or higher, etc</li>
</ul></li>
<li><strong>Amenities/Disamenities</strong>
<ul>
<li>e.g., distance to nearest crimes, restaurants, parks, within Center City, etc</li>
</ul></li>
<li><strong>Transportation network</strong>
<ul>
<li>e.g., distance to nearest bus stop, interesection nodes, nearest subway stop</li>
</ul></li>
<li><strong>Neighboring stations</strong>
<ul>
<li>e.g., average trips of nearest stations, distance to nearest stations</li>
</ul></li>
</ul>
<p><strong>Let’s add a few from each category…</strong></p>
</section>
<section id="internal-characteristics" class="level3">
<h3 class="anchored" data-anchor-id="internal-characteristics">1. Internal characteristics</h3>
<p>Let’s use the number of docks per stations:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="102">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>bike_data <span class="op">=</span> bike_data.merge(stations[[<span class="st">"kioskId"</span>, <span class="st">"totalDocks"</span>]], on<span class="op">=</span><span class="st">"kioskId"</span>)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>bike_data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="102">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">kioskId</th>
<th data-quarto-table-cell-role="th">start_station</th>
<th data-quarto-table-cell-role="th">total_start_trips</th>
<th data-quarto-table-cell-role="th">totalDocks</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>POINT (-8364995.156 4858291.368)</td>
<td>3005</td>
<td>3005</td>
<td>21489</td>
<td>13</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>POINT (-8371571.911 4858998.543)</td>
<td>3006</td>
<td>3006</td>
<td>35810</td>
<td>17</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>POINT (-8366765.136 4857977.729)</td>
<td>3007</td>
<td>3007</td>
<td>69165</td>
<td>20</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>POINT (-8365734.317 4863154.033)</td>
<td>3008</td>
<td>3008</td>
<td>13899</td>
<td>17</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>POINT (-8370092.475 4859515.524)</td>
<td>3009</td>
<td>3009</td>
<td>47041</td>
<td>14</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="census-demographic-data" class="level3">
<h3 class="anchored" data-anchor-id="census-demographic-data">2. Census demographic data</h3>
<p>We’ll try out percent commuting by car first.</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="103">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cenpy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="122">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>acs <span class="op">=</span> cenpy.remote.APIConnection(<span class="st">"ACSDT5Y2021"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="123">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>acs.varslike(<span class="st">"B08134"</span>).sort_index().iloc[:<span class="dv">15</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="123">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">concept</th>
<th data-quarto-table-cell-role="th">predicateType</th>
<th data-quarto-table-cell-role="th">group</th>
<th data-quarto-table-cell-role="th">limit</th>
<th data-quarto-table-cell-role="th">predicateOnly</th>
<th data-quarto-table-cell-role="th">hasGeoCollectionSupport</th>
<th data-quarto-table-cell-role="th">attributes</th>
<th data-quarto-table-cell-role="th">required</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">B08134_001E</td>
<td>Estimate!!Total:</td>
<td>MEANS OF TRANSPORTATION TO WORK BY TRAVEL TIME...</td>
<td>int</td>
<td>B08134</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>B08134_001EA,B08134_001M,B08134_001MA</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">B08134_002E</td>
<td>Estimate!!Total:!!Less than 10 minutes</td>
<td>MEANS OF TRANSPORTATION TO WORK BY TRAVEL TIME...</td>
<td>int</td>
<td>B08134</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>B08134_002EA,B08134_002M,B08134_002MA</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">B08134_003E</td>
<td>Estimate!!Total:!!10 to 14 minutes</td>
<td>MEANS OF TRANSPORTATION TO WORK BY TRAVEL TIME...</td>
<td>int</td>
<td>B08134</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>B08134_003EA,B08134_003M,B08134_003MA</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">B08134_004E</td>
<td>Estimate!!Total:!!15 to 19 minutes</td>
<td>MEANS OF TRANSPORTATION TO WORK BY TRAVEL TIME...</td>
<td>int</td>
<td>B08134</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>B08134_004EA,B08134_004M,B08134_004MA</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">B08134_005E</td>
<td>Estimate!!Total:!!20 to 24 minutes</td>
<td>MEANS OF TRANSPORTATION TO WORK BY TRAVEL TIME...</td>
<td>int</td>
<td>B08134</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>B08134_005EA,B08134_005M,B08134_005MA</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">B08134_006E</td>
<td>Estimate!!Total:!!25 to 29 minutes</td>
<td>MEANS OF TRANSPORTATION TO WORK BY TRAVEL TIME...</td>
<td>int</td>
<td>B08134</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>B08134_006EA,B08134_006M,B08134_006MA</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">B08134_007E</td>
<td>Estimate!!Total:!!30 to 34 minutes</td>
<td>MEANS OF TRANSPORTATION TO WORK BY TRAVEL TIME...</td>
<td>int</td>
<td>B08134</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>B08134_007EA,B08134_007M,B08134_007MA</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">B08134_008E</td>
<td>Estimate!!Total:!!35 to 44 minutes</td>
<td>MEANS OF TRANSPORTATION TO WORK BY TRAVEL TIME...</td>
<td>int</td>
<td>B08134</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>B08134_008EA,B08134_008M,B08134_008MA</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">B08134_009E</td>
<td>Estimate!!Total:!!45 to 59 minutes</td>
<td>MEANS OF TRANSPORTATION TO WORK BY TRAVEL TIME...</td>
<td>int</td>
<td>B08134</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>B08134_009EA,B08134_009M,B08134_009MA</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">B08134_010E</td>
<td>Estimate!!Total:!!60 or more minutes</td>
<td>MEANS OF TRANSPORTATION TO WORK BY TRAVEL TIME...</td>
<td>int</td>
<td>B08134</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>B08134_010EA,B08134_010M,B08134_010MA</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">B08134_011E</td>
<td>Estimate!!Total:!!Car, truck, or van:</td>
<td>MEANS OF TRANSPORTATION TO WORK BY TRAVEL TIME...</td>
<td>int</td>
<td>B08134</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>B08134_011EA,B08134_011M,B08134_011MA</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">B08134_012E</td>
<td>Estimate!!Total:!!Car, truck, or van:!!Less th...</td>
<td>MEANS OF TRANSPORTATION TO WORK BY TRAVEL TIME...</td>
<td>int</td>
<td>B08134</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>B08134_012EA,B08134_012M,B08134_012MA</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">B08134_013E</td>
<td>Estimate!!Total:!!Car, truck, or van:!!10 to 1...</td>
<td>MEANS OF TRANSPORTATION TO WORK BY TRAVEL TIME...</td>
<td>int</td>
<td>B08134</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>B08134_013EA,B08134_013M,B08134_013MA</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">B08134_014E</td>
<td>Estimate!!Total:!!Car, truck, or van:!!15 to 1...</td>
<td>MEANS OF TRANSPORTATION TO WORK BY TRAVEL TIME...</td>
<td>int</td>
<td>B08134</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>B08134_014EA,B08134_014M,B08134_014MA</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">B08134_015E</td>
<td>Estimate!!Total:!!Car, truck, or van:!!20 to 2...</td>
<td>MEANS OF TRANSPORTATION TO WORK BY TRAVEL TIME...</td>
<td>int</td>
<td>B08134</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>B08134_015EA,B08134_015M,B08134_015MA</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="124">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Means of Transportation to Work by Travel Time to Work</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>variables <span class="op">=</span> [<span class="st">"NAME"</span>, <span class="st">"B08134_001E"</span>, <span class="st">"B08134_011E"</span>]</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Pull data by census tract</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>census_data <span class="op">=</span> acs.query(</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    cols<span class="op">=</span>variables,</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    geo_unit<span class="op">=</span><span class="st">"block group:*"</span>,</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>    geo_filter<span class="op">=</span>{<span class="st">"state"</span>: <span class="st">"42"</span>,</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>                <span class="st">"county"</span>: <span class="st">"101"</span>, </span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>                <span class="st">"tract"</span>: <span class="st">"*"</span>},</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to the data to floats</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> variables[<span class="dv">1</span>:]:</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>    census_data[col] <span class="op">=</span> census_data[col].astype(<span class="bu">float</span>)</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a><span class="co"># The percent commuting by car</span></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>census_data[<span class="st">"percent_car"</span>] <span class="op">=</span> census_data[<span class="st">"B08134_011E"</span>] <span class="op">/</span> census_data[<span class="st">"B08134_001E"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="125">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>census_data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="125">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">NAME</th>
<th data-quarto-table-cell-role="th">B08134_001E</th>
<th data-quarto-table-cell-role="th">B08134_011E</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">county</th>
<th data-quarto-table-cell-role="th">tract</th>
<th data-quarto-table-cell-role="th">block group</th>
<th data-quarto-table-cell-role="th">percent_car</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Block Group 1, Census Tract 1.01, Philadelphia...</td>
<td>0.0</td>
<td>0.0</td>
<td>42</td>
<td>101</td>
<td>000101</td>
<td>1</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Block Group 2, Census Tract 1.01, Philadelphia...</td>
<td>0.0</td>
<td>0.0</td>
<td>42</td>
<td>101</td>
<td>000101</td>
<td>2</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Block Group 3, Census Tract 1.01, Philadelphia...</td>
<td>0.0</td>
<td>0.0</td>
<td>42</td>
<td>101</td>
<td>000101</td>
<td>3</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Block Group 4, Census Tract 1.01, Philadelphia...</td>
<td>763.0</td>
<td>313.0</td>
<td>42</td>
<td>101</td>
<td>000101</td>
<td>4</td>
<td>0.410223</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Block Group 5, Census Tract 1.01, Philadelphia...</td>
<td>479.0</td>
<td>191.0</td>
<td>42</td>
<td>101</td>
<td>000101</td>
<td>5</td>
<td>0.398747</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Merge with block group geometries for Philadelphia:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="126">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pygris</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="127">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Query for tracts</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>block_groups <span class="op">=</span> pygris.block_groups(state<span class="op">=</span><span class="st">'42'</span>, county<span class="op">=</span><span class="st">'101'</span>, year<span class="op">=</span><span class="dv">2021</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="128">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>census_data <span class="op">=</span> block_groups.merge(</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    census_data,</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span>[<span class="st">"STATEFP"</span>, <span class="st">"COUNTYFP"</span>, <span class="st">"TRACTCE"</span>, <span class="st">"BLKGRPCE"</span>],</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span>[<span class="st">"state"</span>, <span class="st">"county"</span>, <span class="st">"tract"</span>, <span class="st">"block group"</span>],</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, let’s merge the census data into our dataframe of features by spatially joining the stations and the block groups:</p>
<p><strong>Each station gets the census data associated with the block group the station is within.</strong></p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="129">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>bike_data <span class="op">=</span> gpd.sjoin(</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    bike_data,</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    census_data.to_crs(bike_data.crs)[[<span class="st">"geometry"</span>, <span class="st">"percent_car"</span>]],</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    predicate<span class="op">=</span><span class="st">"within"</span>,</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>).drop(labels<span class="op">=</span>[<span class="st">"index_right"</span>], axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="130">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>bike_data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="130">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">kioskId</th>
<th data-quarto-table-cell-role="th">start_station</th>
<th data-quarto-table-cell-role="th">total_start_trips</th>
<th data-quarto-table-cell-role="th">totalDocks</th>
<th data-quarto-table-cell-role="th">percent_car</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>POINT (-8364995.156 4858291.368)</td>
<td>3005</td>
<td>3005</td>
<td>21489</td>
<td>13</td>
<td>0.509434</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">8</td>
<td>POINT (-8365532.829 4858294.272)</td>
<td>3015</td>
<td>3015</td>
<td>27947</td>
<td>11</td>
<td>0.509434</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>POINT (-8371571.911 4858998.543)</td>
<td>3006</td>
<td>3006</td>
<td>35810</td>
<td>17</td>
<td>0.046414</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">98</td>
<td>POINT (-8371183.406 4858854.781)</td>
<td>3159</td>
<td>3159</td>
<td>28892</td>
<td>23</td>
<td>0.046414</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>POINT (-8366765.136 4857977.729)</td>
<td>3007</td>
<td>3007</td>
<td>69165</td>
<td>20</td>
<td>0.188889</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<section id="impute-missing-values-with-the-median-value" class="level4">
<h4 class="anchored" data-anchor-id="impute-missing-values-with-the-median-value">“Impute” missing values with the median value</h4>
<p>Note: scikit-learn contains preprocessing transformers to do more advanced imputation methods. <a href="https://scikit-learn.org/stable/modules/impute.html">The documentation</a> contains a good description of the options.</p>
<p>In particular, the <code>SimpleImputer</code> object (see the <a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.SimpleImputer.html">docs</a>) can fill values based on the median, mean, most frequent value, or a constant value.</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="132">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>missing <span class="op">=</span> bike_data[<span class="st">'percent_car'</span>].isnull()</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>bike_data.loc[missing, <span class="st">'percent_car'</span>] <span class="op">=</span> bike_data[<span class="st">'percent_car'</span>].median()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="amenitiesdisamenities" class="level3">
<h3 class="anchored" data-anchor-id="amenitiesdisamenities">3. Amenities/disamenities</h3>
<p>Let’s add two new features:</p>
<ol type="1">
<li>Distances to the nearest 10 restaurants from Open Street Map</li>
<li>Whether the station is located within Center City</li>
</ol>
<section id="restaurants" class="level4">
<h4 class="anchored" data-anchor-id="restaurants">Restaurants</h4>
<p>Search https://wiki.openstreetmap.org/wiki/Map_Features for OSM identifier of restaurants</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="134">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>restaurants <span class="op">=</span> ox.features_from_polygon(</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    city_limits_outline, tags<span class="op">=</span>{<span class="st">"amenity"</span>: <span class="st">"restaurant"</span>}</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>).to_crs(epsg<span class="op">=</span><span class="dv">3857</span>)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>restaurants.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/nhand/mambaforge/envs/musa-550-fall-2023/lib/python3.10/site-packages/shapely/predicates.py:798: RuntimeWarning: invalid value encountered in intersects
  return lib.intersects(a, b, **kwargs)
/Users/nhand/mambaforge/envs/musa-550-fall-2023/lib/python3.10/site-packages/shapely/set_operations.py:340: RuntimeWarning: invalid value encountered in union
  return lib.union(a, b, **kwargs)
/Users/nhand/mambaforge/envs/musa-550-fall-2023/lib/python3.10/site-packages/shapely/predicates.py:798: RuntimeWarning: invalid value encountered in intersects
  return lib.intersects(a, b, **kwargs)
/Users/nhand/mambaforge/envs/musa-550-fall-2023/lib/python3.10/site-packages/shapely/predicates.py:798: RuntimeWarning: invalid value encountered in intersects
  return lib.intersects(a, b, **kwargs)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="134">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">amenity</th>
<th data-quarto-table-cell-role="th">created_by</th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">wheelchair</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">addr:city</th>
<th data-quarto-table-cell-role="th">addr:housenumber</th>
<th data-quarto-table-cell-role="th">addr:postcode</th>
<th data-quarto-table-cell-role="th">addr:street</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">payment:cards</th>
<th data-quarto-table-cell-role="th">ship:type</th>
<th data-quarto-table-cell-role="th">building:levels</th>
<th data-quarto-table-cell-role="th">area</th>
<th data-quarto-table-cell-role="th">image</th>
<th data-quarto-table-cell-role="th">name:ja</th>
<th data-quarto-table-cell-role="th">name:zn</th>
<th data-quarto-table-cell-role="th">nonsquare</th>
<th data-quarto-table-cell-role="th">kitchen_hours</th>
<th data-quarto-table-cell-role="th">layer</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">element_type</th>
<th data-quarto-table-cell-role="th">osmid</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">node</td>
<td data-quarto-table-cell-role="th">333786044</td>
<td>restaurant</td>
<td>Potlatch 0.10f</td>
<td>Sam's Morning Glory</td>
<td>knowledge</td>
<td>limited</td>
<td>POINT (-8366653.605 4857351.702)</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">566683522</td>
<td>restaurant</td>
<td>NaN</td>
<td>Spring Garden Pizza &amp; Restaurant</td>
<td>NaN</td>
<td>NaN</td>
<td>POINT (-8366499.795 4860429.601)</td>
<td>Philadelphia</td>
<td>1139</td>
<td>19123</td>
<td>Spring Garden Street</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">596230881</td>
<td>restaurant</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>POINT (-8369759.051 4873925.895)</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">596245658</td>
<td>restaurant</td>
<td>NaN</td>
<td>Earth Bread &amp; Brewery</td>
<td>NaN</td>
<td>NaN</td>
<td>POINT (-8370151.987 4874548.737)</td>
<td>NaN</td>
<td>7136</td>
<td>NaN</td>
<td>Germantown Ave</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">596245661</td>
<td>restaurant</td>
<td>NaN</td>
<td>Cresheim Valley Grain Exchange</td>
<td>NaN</td>
<td>NaN</td>
<td>POINT (-8370193.386 4874608.965)</td>
<td>NaN</td>
<td>7152</td>
<td>NaN</td>
<td>Germantown Avenue</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>5 rows × 121 columns</p>
</div>
</div>
</div>
<p>Get x/y values for the stations:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="135">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>stationsXY <span class="op">=</span> get_xy_from_geometry(bike_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="136">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 1: x/y coordinates of restaurants (in EPGS=3857)</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>restsXY <span class="op">=</span> get_xy_from_geometry(restaurants.to_crs(epsg<span class="op">=</span><span class="dv">3857</span>))</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 2: Initialize the algorithm</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>nbrs <span class="op">=</span> NearestNeighbors(n_neighbors<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 3: Fit the algorithm on the "neighbors" dataset</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>nbrs.fit(restsXY)</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 4: Get distances for stations to neighbors</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>restsDists, restsIndices <span class="op">=</span> nbrs.kneighbors(stationsXY)</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 5: add back to the original dataset</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>bike_data[<span class="st">'logDistRests'</span>] <span class="op">=</span> np.log10(restsDists.mean(axis<span class="op">=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="137">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>bike_data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="137">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">kioskId</th>
<th data-quarto-table-cell-role="th">start_station</th>
<th data-quarto-table-cell-role="th">total_start_trips</th>
<th data-quarto-table-cell-role="th">totalDocks</th>
<th data-quarto-table-cell-role="th">percent_car</th>
<th data-quarto-table-cell-role="th">logDistRests</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>POINT (-8364995.156 4858291.368)</td>
<td>3005</td>
<td>3005</td>
<td>21489</td>
<td>13</td>
<td>0.509434</td>
<td>2.316837</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">8</td>
<td>POINT (-8365532.829 4858294.272)</td>
<td>3015</td>
<td>3015</td>
<td>27947</td>
<td>11</td>
<td>0.509434</td>
<td>2.622287</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>POINT (-8371571.911 4858998.543)</td>
<td>3006</td>
<td>3006</td>
<td>35810</td>
<td>17</td>
<td>0.046414</td>
<td>2.408573</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">98</td>
<td>POINT (-8371183.406 4858854.781)</td>
<td>3159</td>
<td>3159</td>
<td>28892</td>
<td>23</td>
<td>0.046414</td>
<td>2.686011</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>POINT (-8366765.136 4857977.729)</td>
<td>3007</td>
<td>3007</td>
<td>69165</td>
<td>20</td>
<td>0.188889</td>
<td>2.586702</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="138">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="co"># stations</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>bike_data.plot(ax<span class="op">=</span>ax, column<span class="op">=</span><span class="st">'logDistRests'</span>, legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the basemap underneath</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>ctx.add_basemap(ax<span class="op">=</span>ax, crs<span class="op">=</span>bike_data.crs, source<span class="op">=</span>ctx.providers.CartoDB.DarkMatter)</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>ax.set_axis_off()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lecture-13B_files/figure-html/cell-73-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="within-the-center-city-business-district" class="level4">
<h4 class="anchored" data-anchor-id="within-the-center-city-business-district">Within the Center City business district</h4>
<p>Available from <a href="https://www.opendataphilly.org/dataset/center-city-business-improvement-district">OpenDataPhilly</a></p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="139">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"http://data.phl.opendata.arcgis.com/datasets/95366b115d93443eae4cc6f498cb3ca3_0.geojson"</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>ccbd <span class="op">=</span> gpd.read_file(url).to_crs(epsg<span class="op">=</span><span class="dv">3857</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="140">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>ccbd_geo <span class="op">=</span> ccbd.squeeze().geometry</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>ccbd_geo</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="140">
<p><img src="lecture-13B_files/figure-html/cell-75-output-1.svg" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="141">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the new feature: 1 if within CC and 0 otherwise</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>bike_data[<span class="st">'within_centerCity'</span>] <span class="op">=</span> bike_data.geometry.within(ccbd_geo).astype(<span class="bu">int</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="transportation-network" class="level3">
<h3 class="anchored" data-anchor-id="transportation-network">4. Transportation Network</h3>
<ul>
<li>Let’s add a feature that calculates the distance to the nearest intersections</li>
<li>We can use the osmnx package</li>
</ul>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="142">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>xmin, ymin, xmax, ymax <span class="op">=</span> bike_data.to_crs(epsg<span class="op">=</span><span class="dv">4326</span>).total_bounds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create the graph object from the bounding box:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="143">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>G <span class="op">=</span> ox.graph_from_bbox(ymax, ymin, xmax, xmin, network_type<span class="op">=</span><span class="st">'bike'</span>)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>G</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/nhand/mambaforge/envs/musa-550-fall-2023/lib/python3.10/site-packages/shapely/predicates.py:798: RuntimeWarning: invalid value encountered in intersects
  return lib.intersects(a, b, **kwargs)
/Users/nhand/mambaforge/envs/musa-550-fall-2023/lib/python3.10/site-packages/shapely/set_operations.py:340: RuntimeWarning: invalid value encountered in union
  return lib.union(a, b, **kwargs)
/Users/nhand/mambaforge/envs/musa-550-fall-2023/lib/python3.10/site-packages/shapely/set_operations.py:340: RuntimeWarning: invalid value encountered in union
  return lib.union(a, b, **kwargs)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="143">
<pre><code>&lt;networkx.classes.multidigraph.MultiDiGraph at 0x17c48c9d0&gt;</code></pre>
</div>
</div>
<p>Let’s plot the graph using the built-in plotting from osmnx:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="144">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>ox.plot_graph(G, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">12</span>), node_size<span class="op">=</span><span class="dv">0</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lecture-13B_files/figure-html/cell-79-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Now extract the nodes (intersections) from the graph into a GeoDataFrame:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="145">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>intersections <span class="op">=</span> ox.graph_to_gdfs(G, nodes<span class="op">=</span><span class="va">True</span>, edges<span class="op">=</span><span class="va">False</span>).to_crs(epsg<span class="op">=</span><span class="dv">3857</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="146">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>intersections.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="146">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">y</th>
<th data-quarto-table-cell-role="th">x</th>
<th data-quarto-table-cell-role="th">street_count</th>
<th data-quarto-table-cell-role="th">highway</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">osmid</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">109727072</td>
<td>39.920114</td>
<td>-75.176365</td>
<td>3</td>
<td>NaN</td>
<td>POINT (-8368594.627 4854340.318)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">109727084</td>
<td>39.918876</td>
<td>-75.176639</td>
<td>3</td>
<td>NaN</td>
<td>POINT (-8368625.162 4854160.598)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">109727165</td>
<td>39.917601</td>
<td>-75.176933</td>
<td>3</td>
<td>NaN</td>
<td>POINT (-8368657.901 4853975.496)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">109727173</td>
<td>39.917476</td>
<td>-75.176959</td>
<td>4</td>
<td>NaN</td>
<td>POINT (-8368660.784 4853957.411)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">109727183</td>
<td>39.917126</td>
<td>-75.177038</td>
<td>3</td>
<td>NaN</td>
<td>POINT (-8368669.590 4853906.554)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Now, compute the average distance to the 3 nearest intersections:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="147">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 1: x/y coordinates of restaurants (in EPGS=3857)</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>intersectionsXY <span class="op">=</span> get_xy_from_geometry(intersections.to_crs(epsg<span class="op">=</span><span class="dv">3857</span>))</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 2: Initialize the algorithm</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>nbrs <span class="op">=</span> NearestNeighbors(n_neighbors<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 3: Fit the algorithm on the "neighbors" dataset</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>nbrs.fit(intersectionsXY)</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 4: Get distances for stations to neighbors</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>interDists, interIndices <span class="op">=</span> nbrs.kneighbors(stationsXY)</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 5: add back to the original dataset</span></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>bike_data[<span class="st">'logIntersectionDists'</span>] <span class="op">=</span> np.log10(interDists.mean(axis<span class="op">=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s plot the stations, coloring by the new feature (distance to intersections):</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="148">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="co"># stations</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>bike_data.plot(ax<span class="op">=</span>ax, column<span class="op">=</span><span class="st">'logIntersectionDists'</span>, legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the basemap underneath</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>ctx.add_basemap(ax<span class="op">=</span>ax, crs<span class="op">=</span>bike_data.crs, source<span class="op">=</span>ctx.providers.CartoDB.DarkMatter)</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>ax.set_axis_off()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lecture-13B_files/figure-html/cell-83-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="neighboring-stations" class="level3">
<h3 class="anchored" data-anchor-id="neighboring-stations">5. Neighboring Stations</h3>
<ul>
<li>We need to include features that encodes the fact that demand for a specific station is likely related to the demand in neighboring stations</li>
<li>This idea is known as <strong>spatial lag</strong></li>
</ul>
<p>We will add two new features:</p>
<ol type="1">
<li>The average distance to the nearest 5 stations</li>
<li>The average trip total for the nearest 5 stations</li>
</ol>
<p>First, find the nearest 5 stations:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="149">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> N <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>nbrs <span class="op">=</span> NearestNeighbors(n_neighbors<span class="op">=</span>k)</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>nbrs.fit(stationsXY)</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>stationDists, stationIndices <span class="op">=</span> nbrs.kneighbors(stationsXY)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="notes" class="level4">
<h4 class="anchored" data-anchor-id="notes">Notes</h4>
<ul>
<li>We are matching the stations to themselves to find the nearest neighbors</li>
<li>The closest match will always be the same station (distance of 0)</li>
<li>So we fit for <span class="math inline">\(k+1\)</span> neighbors and will remove the closest neighbor</li>
</ul>
<p>The log of the distances to the 5 nearest stations:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="150">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>bike_data[<span class="st">"logStationDists"</span>] <span class="op">=</span> np.log10(stationDists[:, <span class="dv">1</span>:].mean(axis<span class="op">=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="151">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="co"># stations</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>bike_data.plot(ax<span class="op">=</span>ax, column<span class="op">=</span><span class="st">'logStationDists'</span>, legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the basemap underneath</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>ctx.add_basemap(ax<span class="op">=</span>ax, crs<span class="op">=</span>bike_data.crs, source<span class="op">=</span>ctx.providers.CartoDB.DarkMatter)</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>ax.set_axis_off()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lecture-13B_files/figure-html/cell-86-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Now, let’s add the trip counts of the 5 neighboring stations:</p>
<p><strong>Use the indices returned by the NearestNeighbors() algorithm to identify which stations are the 5 neighbors in the original data</strong></p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="152">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>stationIndices[:, <span class="dv">1</span>:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="152">
<pre><code>array([[ 44,  42,   1,  43,  21],
       [ 43,   0,  42,  44,  31],
       [ 99,   3, 103,  72,  19],
       [ 99,   2,  23,  36, 103],
       [ 82,  48,   7,  30,   8],
       [ 26,  12,  53,  62,  37],
       [ 23,  18,  69, 103, 104],
       [ 60,   8, 112,   4,  63],
       [ 60,   7,  75,  63,   4],
       [ 27,  29,  63,  91,  61],
       [ 52, 114,  56, 107,  50],
       [ 62,  37,  73,  38,  71],
       [  5,  79,  26,  76, 108],
       [ 32,  35,  30,  46,  31],
       [ 43,  46,  31, 110,  42],
       [ 36,  28,  16,  23, 105],
       [ 36,  15,   3,  99,  23],
       [ 74, 112,  58, 114, 109],
       [104,  59,  57,   6, 107],
       [ 99,   2,  72,   3,  89],
       [ 66,  24,  33,  65,  75],
       [ 22,  44,   0,  67,   1],
       [ 21,  67,  25,  24,  80],
       [103,   6,   3,  36,  15],
       [ 25,  20,  82,  66,  67],
       [ 24,  22,  67,  82,  20],
       [  5,  53,  12,  37,  62],
       [ 29,   9,  28, 105,  63],
       [ 29,  27, 105,  15,   9],
       [ 27,  28,   9, 105,  63],
       [ 31,  32,  48,  13,  46],
       [ 30,  46,  32,  43,  48],
       [ 13,  30,  35,  31,  46],
       [ 66,  20,  65, 106,  98],
       [ 84,  64,  69, 103,   6],
       [ 13,  32,  30,  46, 100],
       [ 16,  15,   3,  23,  99],
       [ 38,  73,  11,  53,  92],
       [ 37,  92,  73,  53,  54],
       [ 55,  56,  54,  52,  73],
       [108,  76,  87,  68,  79],
       [ 98,  49, 102,  65,  61],
       [  0,  43, 110,   1,  44],
       [ 14,   1,  42,  31,  46],
       [  0,  21,  42,   1,  22],
       [110,  42,  68,   0,  14],
       [ 31,  14,  30,  32,  13],
       [ 83,  54,  51,  50,  92],
       [ 30,   4,  31,  32,  82],
       [ 41,  91,  61,  98,   9],
       [ 52,  10,  56,  51,  47],
       [ 83,  50,  47, 107,  69],
       [ 56,  10, 114,  50, 107],
       [ 26,  37,  38,   5,  62],
       [ 47,  39,  50,  92,  73],
       [ 39, 100,  73,  71,  56],
       [ 52, 114,  10,  50,  39],
       [104,  59,  58, 107, 109],
       [ 74, 109,  57, 114,  17],
       [105,  57, 104,  18, 109],
       [  7,  63,   8, 112, 109],
       [  9,  75,  91,  65,   8],
       [ 11,  37,  76,  53,  73],
       [ 60,   9,  27,   8, 109],
       [ 34,  84,  95, 103,  69],
       [ 33,  75,  20,  66,  61],
       [ 33,  20,  65,  24, 106],
       [ 80,  22,  25,  70,  24],
       [ 87,  45, 110,  40,  76],
       [ 34,  84,   6,  51,  18],
       [ 80,  67,  22,  21,  81],
       [100,  55,  14,  11,  46],
       [ 94,   2,  89,  19,  99],
       [ 37,  55,  38,  11,  39],
       [ 58,  17, 109, 112, 114],
       [  8,  65,  61,  20,  82],
       [ 40, 108,  62,  87,  68],
       [ 85,  78,  86,  96,  97],
       [ 85,  77,  86,  97,  96],
       [108,  12,  40,  76,   5],
       [ 67,  70,  81,  22,  25],
       [ 80, 101,  70,  67,  66],
       [  4,  24,  48,  25,  20],
       [ 51,  47,  50,  54,  69],
       [ 34,  69,  64,  90,  96],
       [ 77,  78,  86,  96,  97],
       [ 77,  96,  85,  90,  78],
       [ 68,  40,  45,  76, 110],
       [ 93,  95,  90,  64,  94],
       [ 94,  72,  19,   2,  99],
       [ 96,  84,  86,  64,  95],
       [  9,  61,  49,  29,  27],
       [ 38,  54,  37,  73,  47],
       [ 88,  95,  90,  94,  64],
       [ 72,  89,  95,   2,  19],
       [ 64,  94,  90,  34,  72],
       [ 86,  90,  83,  84,  47],
       [ 92,  38,  53,  37,  26],
       [102, 106,  41,  65,  33],
       [  2,   3,  19,  16,  36],
       [ 55,  71,  35,  46,  13],
       [106,  81, 102,  33,  98],
       [ 98, 106,  41, 101,  33],
       [ 23,   3,   2,   6,  34],
       [ 18,  57,  59, 107, 105],
       [ 59,  27,  28, 104,  57],
       [ 98, 102, 101,  33,  66],
       [ 10, 104,  57, 114,  52],
       [ 40,  76,  79,  87,  12],
       [ 58,  74, 112,  57,  59],
       [ 45,  42,  14,  43,   0],
       [113, 115, 102, 101, 106],
       [ 17,  74, 109,  60,   7],
       [111, 115, 102, 101,  98],
       [ 10,  56,  52,  58,  74],
       [111, 113, 102, 101,  98]])</code></pre>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="153">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the total trips for the stations from original data frame</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>total_start_trips <span class="op">=</span> bike_data[<span class="st">'total_start_trips'</span>].values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="154">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>total_start_trips</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="154">
<pre><code>array([21489, 27947, 35810, 28892, 69165, 13899, 47041, 93916, 44622,
       60187, 13031,  7115, 11863, 45434, 16961, 55691,  7343, 58307,
       57073, 20127, 32433, 34331, 61592, 44565, 39669, 33963, 23814,
       76540, 27736, 29139, 40564, 37390, 45958, 37428, 28092, 39622,
       41670, 25990, 15460, 41777, 23859, 32078, 57086, 41466, 31487,
       26086, 34651, 37950, 70320, 33841, 76197, 73758, 30678, 30889,
       45196, 39962, 22193, 45734, 39869, 24477, 48285, 43113, 11012,
       60386,  8609, 37196, 27935, 31137, 14511, 21116, 21541, 26265,
       26015, 31759, 45904, 32250, 24691,  6164,  5985, 16240, 20299,
       39861, 66350, 64882, 10512,  8410, 10036, 17607,  9292, 17148,
        4985, 38463, 13656,  5106, 15065,  9527, 26922,  8486, 17799,
       11669, 46670, 23682, 25833, 33808, 39587, 48734, 25068, 27349,
       15742, 64969, 28877,  4497, 36943,  4409, 19432, 11616])</code></pre>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="155">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the trips for the 5 nearest neighbors (ignoring first match)</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>neighboring_trips <span class="op">=</span> total_start_trips[stationIndices[:, <span class="dv">1</span>:]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="156">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>neighboring_trips</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="156">
<pre><code>array([[31487, 57086, 27947, 41466, 34331],
       [41466, 21489, 57086, 31487, 37390],
       [11669, 28892, 33808, 26015, 20127],
       [11669, 35810, 44565, 41670, 33808],
       [66350, 70320, 93916, 40564, 44622],
       [23814, 11863, 30889, 11012, 25990],
       [44565, 57073, 21116, 33808, 39587],
       [48285, 44622, 36943, 69165, 60386],
       [48285, 93916, 32250, 60386, 69165],
       [76540, 29139, 60386, 38463, 43113],
       [30678, 19432, 22193, 27349, 76197],
       [11012, 25990, 31759, 15460, 26265],
       [13899, 16240, 23814, 24691, 15742],
       [45958, 39622, 40564, 34651, 37390],
       [41466, 34651, 37390, 28877, 57086],
       [41670, 27736,  7343, 44565, 48734],
       [41670, 55691, 28892, 11669, 44565],
       [45904, 36943, 39869, 19432, 64969],
       [39587, 24477, 45734, 47041, 27349],
       [11669, 35810, 26015, 28892, 17148],
       [27935, 39669, 37428, 37196, 32250],
       [61592, 31487, 21489, 31137, 27947],
       [34331, 31137, 33963, 39669, 20299],
       [33808, 47041, 28892, 41670, 55691],
       [33963, 32433, 66350, 27935, 31137],
       [39669, 61592, 31137, 66350, 32433],
       [13899, 30889, 11863, 25990, 11012],
       [29139, 60187, 27736, 48734, 60386],
       [29139, 76540, 48734, 55691, 60187],
       [76540, 27736, 60187, 48734, 60386],
       [37390, 45958, 70320, 45434, 34651],
       [40564, 34651, 45958, 41466, 70320],
       [45434, 40564, 39622, 37390, 34651],
       [27935, 32433, 37196, 25068, 17799],
       [10512,  8609, 21116, 33808, 47041],
       [45434, 45958, 40564, 34651, 46670],
       [ 7343, 55691, 28892, 44565, 11669],
       [15460, 31759,  7115, 30889, 13656],
       [25990, 13656, 31759, 30889, 45196],
       [39962, 22193, 45196, 30678, 31759],
       [15742, 24691, 17607, 14511, 16240],
       [17799, 33841, 25833, 37196, 43113],
       [21489, 41466, 28877, 27947, 31487],
       [16961, 27947, 57086, 37390, 34651],
       [21489, 34331, 57086, 27947, 61592],
       [28877, 57086, 14511, 21489, 16961],
       [37390, 16961, 40564, 45958, 45434],
       [64882, 45196, 73758, 76197, 13656],
       [40564, 69165, 37390, 45958, 66350],
       [32078, 38463, 43113, 17799, 60187],
       [30678, 13031, 22193, 73758, 37950],
       [64882, 76197, 37950, 27349, 21116],
       [22193, 13031, 19432, 76197, 27349],
       [23814, 25990, 15460, 13899, 11012],
       [37950, 41777, 76197, 13656, 31759],
       [41777, 46670, 31759, 26265, 22193],
       [30678, 19432, 13031, 76197, 41777],
       [39587, 24477, 39869, 27349, 64969],
       [45904, 64969, 45734, 19432, 58307],
       [48734, 45734, 39587, 57073, 64969],
       [93916, 60386, 44622, 36943, 64969],
       [60187, 32250, 38463, 37196, 44622],
       [ 7115, 25990, 24691, 30889, 31759],
       [48285, 60187, 76540, 44622, 64969],
       [28092, 10512,  9527, 33808, 21116],
       [37428, 32250, 32433, 27935, 43113],
       [37428, 32433, 37196, 39669, 25068],
       [20299, 61592, 33963, 21541, 39669],
       [17607, 26086, 28877, 23859, 24691],
       [28092, 10512, 47041, 73758, 57073],
       [20299, 31137, 61592, 34331, 39861],
       [46670, 39962, 16961,  7115, 34651],
       [15065, 35810, 17148, 20127, 11669],
       [25990, 39962, 15460,  7115, 41777],
       [39869, 58307, 64969, 36943, 19432],
       [44622, 37196, 43113, 32433, 66350],
       [23859, 15742, 11012, 17607, 14511],
       [ 8410,  5985, 10036, 26922,  8486],
       [ 8410,  6164, 10036,  8486, 26922],
       [15742, 11863, 23859, 24691, 13899],
       [31137, 21541, 39861, 61592, 33963],
       [20299, 23682, 21541, 31137, 27935],
       [69165, 39669, 70320, 33963, 32433],
       [73758, 37950, 76197, 45196, 21116],
       [28092, 21116,  8609,  4985, 26922],
       [ 6164,  5985, 10036, 26922,  8486],
       [ 6164, 26922,  8410,  4985,  5985],
       [14511, 23859, 26086, 24691, 28877],
       [ 5106,  9527,  4985,  8609, 15065],
       [15065, 26015, 20127, 35810, 11669],
       [26922, 10512, 10036,  8609,  9527],
       [60187, 43113, 33841, 29139, 76540],
       [15460, 45196, 25990, 31759, 37950],
       [ 9292,  9527,  4985, 15065,  8609],
       [26015, 17148,  9527, 35810, 20127],
       [ 8609, 15065,  4985, 28092, 26015],
       [10036,  4985, 64882, 10512, 37950],
       [13656, 15460, 30889, 25990, 23814],
       [25833, 25068, 32078, 37196, 37428],
       [35810, 28892, 20127,  7343, 41670],
       [39962, 26265, 39622, 34651, 45434],
       [25068, 39861, 25833, 37428, 17799],
       [17799, 25068, 32078, 23682, 37428],
       [44565, 28892, 35810, 47041, 28092],
       [57073, 45734, 24477, 27349, 48734],
       [24477, 76540, 27736, 39587, 45734],
       [17799, 25833, 23682, 37428, 27935],
       [13031, 39587, 45734, 19432, 30678],
       [23859, 24691, 16240, 17607, 11863],
       [39869, 45904, 36943, 45734, 24477],
       [26086, 57086, 16961, 41466, 21489],
       [ 4409, 11616, 25833, 23682, 25068],
       [58307, 45904, 64969, 48285, 93916],
       [ 4497, 11616, 25833, 23682, 17799],
       [13031, 22193, 30678, 39869, 45904],
       [ 4497,  4409, 25833, 23682, 17799]])</code></pre>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="157">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add to features</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>bike_data[<span class="st">'laggedTrips'</span>] <span class="op">=</span> neighboring_trips.mean(axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="is-there-a-correlation-between-trip-counts-and-the-spatial-lag" class="level4">
<h4 class="anchored" data-anchor-id="is-there-a-correlation-between-trip-counts-and-the-spatial-lag">Is there a correlation between trip counts and the spatial lag?</h4>
<p>Yes!</p>
<p>We can use seaborn to make a quick plot:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="158">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>sns.regplot(x<span class="op">=</span>bike_data[<span class="st">'laggedTrips'</span>], y<span class="op">=</span>bike_data[<span class="st">'total_start_trips'</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lecture-13B_files/figure-html/cell-93-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="lets-look-at-the-correlations-of-all-of-our-features" class="level3">
<h3 class="anchored" data-anchor-id="lets-look-at-the-correlations-of-all-of-our-features">Let’s look at the correlations of all of our features</h3>
<p>Again, use seaborn to investigate.</p>
<p><strong>Remember:</strong> we don’t want to include multipl features that are highly correlated in our model.</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="159">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>feature_cols <span class="op">=</span> [</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_start_trips"</span>,</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"totalDocks"</span>,</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"percent_car"</span>,</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"logDistRests"</span>,</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"within_centerCity"</span>,</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"logIntersectionDists"</span>,</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"logStationDists"</span>,</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"laggedTrips"</span>,</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>sns.heatmap(</span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>    bike_data[feature_cols].corr(), cmap<span class="op">=</span><span class="st">"coolwarm"</span>, annot<span class="op">=</span><span class="va">True</span>, vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span></span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lecture-13B_files/figure-html/cell-94-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="lets-fit-a-model" class="level3">
<h3 class="anchored" data-anchor-id="lets-fit-a-model">Let’s fit a model!</h3>
<p>Just as before, the plan is to: - Fit a random forest model, using cross validation to optimize (some) hyperparameters - Compare to a baseline linear regression model</p>
</section>
<section id="perform-our-testtrain-split" class="level3">
<h3 class="anchored" data-anchor-id="perform-our-testtrain-split">Perform our test/train split</h3>
<p>We’ll use a 60%/40% split, due to the relatively small number of stations.</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="160">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove unnecessary columns</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>bike_features <span class="op">=</span> bike_data.drop(labels<span class="op">=</span>[<span class="st">"geometry"</span>, <span class="st">"kioskId"</span>, <span class="st">"start_station"</span>], axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="161">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Split the data </span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>train_set, test_set <span class="op">=</span> train_test_split(</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>    bike_features,</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>    test_size<span class="op">=</span><span class="fl">0.4</span>,</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span><span class="dv">12345</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a><span class="co"># the target labels: log of total start trips</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> np.log(train_set[<span class="st">"total_start_trips"</span>])</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> np.log(test_set[<span class="st">"total_start_trips"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="162">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract out only the features we want to use</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>feature_cols <span class="op">=</span> [</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"totalDocks"</span>,</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"percent_car"</span>,</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"logDistRests"</span>,</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"within_centerCity"</span>,</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"logIntersectionDists"</span>,</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"logStationDists"</span>,</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"laggedTrips"</span>,</span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>train_set <span class="op">=</span> train_set[feature_cols]</span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>test_set <span class="op">=</span> test_set[feature_cols]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="random-forest-results" class="level3">
<h3 class="anchored" data-anchor-id="random-forest-results">Random forest results</h3>
<p>Let’s run a simple grid search to try to optimize our hyperparameters.</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="163">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup the pipeline with a standard scaler</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> make_pipeline(</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>    StandardScaler(), RandomForestRegressor(random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Try out a few different values for two of the main parameters for random forests: <code>n_estimators</code> and <code>max_depth</code>:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="164">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>model_name <span class="op">=</span> <span class="st">"randomforestregressor"</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">__n_estimators"</span>: [<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">25</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">300</span>, <span class="dv">500</span>],</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">__max_depth"</span>: [<span class="va">None</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">9</span>, <span class="dv">13</span>],</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>param_grid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="164">
<pre><code>{'randomforestregressor__n_estimators': [5, 10, 25, 50, 100, 200, 300, 500],
 'randomforestregressor__max_depth': [None, 2, 5, 7, 9, 13]}</code></pre>
</div>
</div>
<p><strong>Important:</strong> just like last week, we will need to prefix the parameter name with the name of the pipeline step, in this case, “randomforestregressor”.</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="165">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the grid and use 10-fold CV</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>grid <span class="op">=</span> GridSearchCV(pipe, param_grid, cv<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the search</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>grid.fit(train_set, y_train)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="evaluate-the-best-estimator-on-the-test-set" class="level4">
<h4 class="anchored" data-anchor-id="evaluate-the-best-estimator-on-the-test-set">Evaluate the best estimator on the test set:</h4>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;fragment&quot;}" data-execution_count="166">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>grid.best_params_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="166">
<pre><code>{'randomforestregressor__max_depth': 5,
 'randomforestregressor__n_estimators': 25}</code></pre>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="167">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate the best random forest model</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>best_random <span class="op">=</span> grid.best_estimator_</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>grid.score(test_set, y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="167">
<pre><code>0.6157065229263337</code></pre>
</div>
</div>
</section>
<section id="evaluate-a-linear-model-baseline-on-the-test-set" class="level4">
<h4 class="anchored" data-anchor-id="evaluate-a-linear-model-baseline-on-the-test-set">Evaluate a linear model (baseline) on the test set</h4>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="168">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up a linear pipeline</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>linear <span class="op">=</span> make_pipeline(StandardScaler(), LinearRegression())</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit on train set</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>linear.fit(train_set, y_train)</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate on test set</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>linear.score(test_set, y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="168">
<pre><code>0.5985061341399598</code></pre>
</div>
</div>
</section>
<section id="only-a-modest-improvement-over-the-baseline-model" class="level4">
<h4 class="anchored" data-anchor-id="only-a-modest-improvement-over-the-baseline-model">Only a modest improvement over the baseline model!</h4>
</section>
</section>
<section id="which-features-were-the-most-important" class="level3">
<h3 class="anchored" data-anchor-id="which-features-were-the-most-important">Which features were the most important?</h3>
<p>From our earlier correlation analysis, we should expect the most important features to be: - the spatially lagged trip counts - the distance to the nearest restaurants - the distance to the nearest stations</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="177">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The best model</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>regressor <span class="op">=</span> grid.best_estimator_[<span class="st">"randomforestregressor"</span>]</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the dataframe with importances</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>importance <span class="op">=</span> pd.DataFrame(</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"Feature"</span>: train_set.columns, <span class="st">"Importance"</span>: regressor.feature_importances_}</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort importance in descending order and get the top</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>importance <span class="op">=</span> importance.sort_values(<span class="st">"Importance"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>importance.hvplot.barh(x<span class="op">=</span><span class="st">"Feature"</span>, y<span class="op">=</span><span class="st">"Importance"</span>, flip_yaxis<span class="op">=</span><span class="va">True</span>, height<span class="op">=</span><span class="dv">300</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="177">
<div id="p1176">
  <div id="b4f62c71-211b-43e6-abf7-0879049de0e9" data-root-id="p1176" style="display: contents;"></div>
</div>
<script type="application/javascript">(function(root) {
  var docs_json = {"07f2c1fa-7f76-4757-8ccd-91ca714f99c2":{"version":"3.2.1","title":"Bokeh Application","roots":[{"type":"object","name":"Row","id":"p1176","attributes":{"name":"Row01320","tags":["embedded"],"stylesheets":["\n:host(.pn-loading.pn-arc):before, .pn-loading.pn-arc:before {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHN0eWxlPSJtYXJnaW46IGF1dG87IGJhY2tncm91bmQ6IG5vbmU7IGRpc3BsYXk6IGJsb2NrOyBzaGFwZS1yZW5kZXJpbmc6IGF1dG87IiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQiPiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjYzNjM2MzIiBzdHJva2Utd2lkdGg9IjEwIiByPSIzNSIgc3Ryb2tlLWRhc2hhcnJheT0iMTY0LjkzMzYxNDMxMzQ2NDE1IDU2Ljk3Nzg3MTQzNzgyMTM4Ij4gICAgPGFuaW1hdGVUcmFuc2Zvcm0gYXR0cmlidXRlTmFtZT0idHJhbnNmb3JtIiB0eXBlPSJyb3RhdGUiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBkdXI9IjFzIiB2YWx1ZXM9IjAgNTAgNTA7MzYwIDUwIDUwIiBrZXlUaW1lcz0iMDsxIj48L2FuaW1hdGVUcmFuc2Zvcm0+ICA8L2NpcmNsZT48L3N2Zz4=\");\n  background-size: auto calc(min(50%, 400px));\n}",{"type":"object","name":"ImportedStyleSheet","id":"p1179","attributes":{"url":"https://cdn.holoviz.org/panel/1.2.1/dist/css/loading.css"}},{"type":"object","name":"ImportedStyleSheet","id":"p1231","attributes":{"url":"https://cdn.holoviz.org/panel/1.2.1/dist/css/listpanel.css"}},{"type":"object","name":"ImportedStyleSheet","id":"p1177","attributes":{"url":"https://cdn.holoviz.org/panel/1.2.1/dist/bundled/theme/default.css"}},{"type":"object","name":"ImportedStyleSheet","id":"p1178","attributes":{"url":"https://cdn.holoviz.org/panel/1.2.1/dist/bundled/theme/native.css"}}],"min_width":700,"margin":0,"sizing_mode":"stretch_width","align":"start","children":[{"type":"object","name":"Spacer","id":"p1180","attributes":{"name":"HSpacer01331","stylesheets":["\n:host(.pn-loading.pn-arc):before, .pn-loading.pn-arc:before {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHN0eWxlPSJtYXJnaW46IGF1dG87IGJhY2tncm91bmQ6IG5vbmU7IGRpc3BsYXk6IGJsb2NrOyBzaGFwZS1yZW5kZXJpbmc6IGF1dG87IiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQiPiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjYzNjM2MzIiBzdHJva2Utd2lkdGg9IjEwIiByPSIzNSIgc3Ryb2tlLWRhc2hhcnJheT0iMTY0LjkzMzYxNDMxMzQ2NDE1IDU2Ljk3Nzg3MTQzNzgyMTM4Ij4gICAgPGFuaW1hdGVUcmFuc2Zvcm0gYXR0cmlidXRlTmFtZT0idHJhbnNmb3JtIiB0eXBlPSJyb3RhdGUiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBkdXI9IjFzIiB2YWx1ZXM9IjAgNTAgNTA7MzYwIDUwIDUwIiBrZXlUaW1lcz0iMDsxIj48L2FuaW1hdGVUcmFuc2Zvcm0+ICA8L2NpcmNsZT48L3N2Zz4=\");\n  background-size: auto calc(min(50%, 400px));\n}",{"id":"p1179"},{"id":"p1177"},{"id":"p1178"}],"margin":0,"sizing_mode":"stretch_width","align":"start"}},{"type":"object","name":"Figure","id":"p1188","attributes":{"width":700,"height":300,"margin":[5,10],"sizing_mode":"fixed","align":"start","x_range":{"type":"object","name":"Range1d","id":"p1181","attributes":{"tags":[[["Importance","Importance",null]],[]],"end":0.5805193737352692,"reset_start":0.0,"reset_end":0.5805193737352692}},"y_range":{"type":"object","name":"FactorRange","id":"p1182","attributes":{"tags":[[["Feature","Feature",null]],{"type":"map","entries":[["invert_yaxis",true],["autorange",false]]}],"factors":["within_centerCity","percent_car","logIntersectionDists","totalDocks","logStationDists","logDistRests","laggedTrips"]}},"x_scale":{"type":"object","name":"LinearScale","id":"p1198"},"y_scale":{"type":"object","name":"CategoricalScale","id":"p1199"},"title":{"type":"object","name":"Title","id":"p1191","attributes":{"text_color":"black","text_font_size":"12pt"}},"renderers":[{"type":"object","name":"GlyphRenderer","id":"p1224","attributes":{"data_source":{"type":"object","name":"ColumnDataSource","id":"p1215","attributes":{"selected":{"type":"object","name":"Selection","id":"p1216","attributes":{"indices":[],"line_indices":[]}},"selection_policy":{"type":"object","name":"UnionRenderers","id":"p1217"},"data":{"type":"map","entries":[["Feature",["laggedTrips","logDistRests","logStationDists","totalDocks","logIntersectionDists","percent_car","within_centerCity"]],["Importance",{"type":"ndarray","array":{"type":"bytes","data":"gqJ9tJjj4D8B2m76w2LLP6c5DKm7Abo/XMpirudMtz9x1jlP1eyhP6V8ZHdO9Z4//ZEpUMpQOz8="},"shape":[7],"dtype":"float64","order":"little"}]]}}},"view":{"type":"object","name":"CDSView","id":"p1225","attributes":{"filter":{"type":"object","name":"AllIndices","id":"p1226"}}},"glyph":{"type":"object","name":"HBar","id":"p1221","attributes":{"tags":["apply_ranges"],"y":{"type":"field","field":"Feature"},"height":{"type":"value","value":0.8},"right":{"type":"field","field":"Importance"},"fill_color":{"type":"value","value":"#30a2da"},"hatch_color":{"type":"value","value":"#30a2da"}}},"selection_glyph":{"type":"object","name":"HBar","id":"p1227","attributes":{"tags":["apply_ranges"],"y":{"type":"field","field":"Feature"},"height":{"type":"value","value":0.8},"left":{"type":"value","value":0},"right":{"type":"field","field":"Importance"},"line_color":{"type":"value","value":"black"},"line_alpha":{"type":"value","value":1.0},"line_width":{"type":"value","value":1},"line_join":{"type":"value","value":"bevel"},"line_cap":{"type":"value","value":"butt"},"line_dash":{"type":"value","value":[]},"line_dash_offset":{"type":"value","value":0},"fill_color":{"type":"value","value":"#30a2da"},"fill_alpha":{"type":"value","value":1.0},"hatch_color":{"type":"value","value":"#30a2da"},"hatch_alpha":{"type":"value","value":1.0},"hatch_scale":{"type":"value","value":12.0},"hatch_pattern":{"type":"value","value":null},"hatch_weight":{"type":"value","value":1.0}}},"nonselection_glyph":{"type":"object","name":"HBar","id":"p1222","attributes":{"tags":["apply_ranges"],"y":{"type":"field","field":"Feature"},"height":{"type":"value","value":0.8},"right":{"type":"field","field":"Importance"},"line_alpha":{"type":"value","value":0.1},"fill_color":{"type":"value","value":"#30a2da"},"fill_alpha":{"type":"value","value":0.1},"hatch_color":{"type":"value","value":"#30a2da"},"hatch_alpha":{"type":"value","value":0.1}}},"muted_glyph":{"type":"object","name":"HBar","id":"p1223","attributes":{"tags":["apply_ranges"],"y":{"type":"field","field":"Feature"},"height":{"type":"value","value":0.8},"right":{"type":"field","field":"Importance"},"line_alpha":{"type":"value","value":0.2},"fill_color":{"type":"value","value":"#30a2da"},"fill_alpha":{"type":"value","value":0.2},"hatch_color":{"type":"value","value":"#30a2da"},"hatch_alpha":{"type":"value","value":0.2}}}}}],"toolbar":{"type":"object","name":"Toolbar","id":"p1197","attributes":{"tools":[{"type":"object","name":"WheelZoomTool","id":"p1186","attributes":{"tags":["hv_created"],"zoom_together":"none"}},{"type":"object","name":"HoverTool","id":"p1187","attributes":{"tags":["hv_created"],"renderers":[{"id":"p1224"}],"tooltips":[["Feature","@{Feature}"],["Importance","@{Importance}"]]}},{"type":"object","name":"SaveTool","id":"p1210"},{"type":"object","name":"PanTool","id":"p1211"},{"type":"object","name":"BoxZoomTool","id":"p1212","attributes":{"overlay":{"type":"object","name":"BoxAnnotation","id":"p1213","attributes":{"syncable":false,"level":"overlay","visible":false,"left_units":"canvas","right_units":"canvas","bottom_units":"canvas","top_units":"canvas","line_color":"black","line_alpha":1.0,"line_width":2,"line_dash":[4,4],"fill_color":"lightgrey","fill_alpha":0.5}}}},{"type":"object","name":"ResetTool","id":"p1214"}],"active_drag":{"id":"p1211"},"active_scroll":{"id":"p1186"}}},"left":[{"type":"object","name":"CategoricalAxis","id":"p1205","attributes":{"ticker":{"type":"object","name":"CategoricalTicker","id":"p1206"},"formatter":{"type":"object","name":"CategoricalTickFormatter","id":"p1207"},"axis_label":"Feature","major_label_policy":{"type":"object","name":"AllLabels","id":"p1208"}}}],"below":[{"type":"object","name":"LinearAxis","id":"p1200","attributes":{"ticker":{"type":"object","name":"BasicTicker","id":"p1201","attributes":{"mantissas":[1,2,5]}},"formatter":{"type":"object","name":"BasicTickFormatter","id":"p1202"},"axis_label":"Importance","major_label_policy":{"type":"object","name":"AllLabels","id":"p1203"}}}],"center":[{"type":"object","name":"Grid","id":"p1204","attributes":{"axis":{"id":"p1200"},"grid_line_color":null}},{"type":"object","name":"Grid","id":"p1209","attributes":{"dimension":1,"axis":{"id":"p1205"},"grid_line_color":null}}],"min_border_top":10,"min_border_bottom":10,"min_border_left":10,"min_border_right":10,"output_backend":"webgl"}},{"type":"object","name":"Spacer","id":"p1229","attributes":{"name":"HSpacer01334","stylesheets":["\n:host(.pn-loading.pn-arc):before, .pn-loading.pn-arc:before {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHN0eWxlPSJtYXJnaW46IGF1dG87IGJhY2tncm91bmQ6IG5vbmU7IGRpc3BsYXk6IGJsb2NrOyBzaGFwZS1yZW5kZXJpbmc6IGF1dG87IiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQiPiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjYzNjM2MzIiBzdHJva2Utd2lkdGg9IjEwIiByPSIzNSIgc3Ryb2tlLWRhc2hhcnJheT0iMTY0LjkzMzYxNDMxMzQ2NDE1IDU2Ljk3Nzg3MTQzNzgyMTM4Ij4gICAgPGFuaW1hdGVUcmFuc2Zvcm0gYXR0cmlidXRlTmFtZT0idHJhbnNmb3JtIiB0eXBlPSJyb3RhdGUiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBkdXI9IjFzIiB2YWx1ZXM9IjAgNTAgNTA7MzYwIDUwIDUwIiBrZXlUaW1lcz0iMDsxIj48L2FuaW1hdGVUcmFuc2Zvcm0+ICA8L2NpcmNsZT48L3N2Zz4=\");\n  background-size: auto calc(min(50%, 400px));\n}",{"id":"p1179"},{"id":"p1177"},{"id":"p1178"}],"margin":0,"sizing_mode":"stretch_width","align":"start"}}]}}],"defs":[{"type":"model","name":"ReactiveHTML1"},{"type":"model","name":"FlexBox1","properties":[{"name":"align_content","kind":"Any","default":"flex-start"},{"name":"align_items","kind":"Any","default":"flex-start"},{"name":"flex_direction","kind":"Any","default":"row"},{"name":"flex_wrap","kind":"Any","default":"wrap"},{"name":"justify_content","kind":"Any","default":"flex-start"}]},{"type":"model","name":"FloatPanel1","properties":[{"name":"config","kind":"Any","default":{"type":"map"}},{"name":"contained","kind":"Any","default":true},{"name":"position","kind":"Any","default":"right-top"},{"name":"offsetx","kind":"Any","default":null},{"name":"offsety","kind":"Any","default":null},{"name":"theme","kind":"Any","default":"primary"},{"name":"status","kind":"Any","default":"normalized"}]},{"type":"model","name":"GridStack1","properties":[{"name":"mode","kind":"Any","default":"warn"},{"name":"ncols","kind":"Any","default":null},{"name":"nrows","kind":"Any","default":null},{"name":"allow_resize","kind":"Any","default":true},{"name":"allow_drag","kind":"Any","default":true},{"name":"state","kind":"Any","default":[]}]},{"type":"model","name":"drag1","properties":[{"name":"slider_width","kind":"Any","default":5},{"name":"slider_color","kind":"Any","default":"black"},{"name":"value","kind":"Any","default":50}]},{"type":"model","name":"click1","properties":[{"name":"terminal_output","kind":"Any","default":""},{"name":"debug_name","kind":"Any","default":""},{"name":"clears","kind":"Any","default":0}]},{"type":"model","name":"FastWrapper1","properties":[{"name":"object","kind":"Any","default":null},{"name":"style","kind":"Any","default":null}]},{"type":"model","name":"NotificationAreaBase1","properties":[{"name":"js_events","kind":"Any","default":{"type":"map"}},{"name":"position","kind":"Any","default":"bottom-right"},{"name":"_clear","kind":"Any","default":0}]},{"type":"model","name":"NotificationArea1","properties":[{"name":"js_events","kind":"Any","default":{"type":"map"}},{"name":"notifications","kind":"Any","default":[]},{"name":"position","kind":"Any","default":"bottom-right"},{"name":"_clear","kind":"Any","default":0},{"name":"types","kind":"Any","default":[{"type":"map","entries":[["type","warning"],["background","#ffc107"],["icon",{"type":"map","entries":[["className","fas fa-exclamation-triangle"],["tagName","i"],["color","white"]]}]]},{"type":"map","entries":[["type","info"],["background","#007bff"],["icon",{"type":"map","entries":[["className","fas fa-info-circle"],["tagName","i"],["color","white"]]}]]}]}]},{"type":"model","name":"Notification","properties":[{"name":"background","kind":"Any","default":null},{"name":"duration","kind":"Any","default":3000},{"name":"icon","kind":"Any","default":null},{"name":"message","kind":"Any","default":""},{"name":"notification_type","kind":"Any","default":null},{"name":"_destroyed","kind":"Any","default":false}]},{"type":"model","name":"TemplateActions1","properties":[{"name":"open_modal","kind":"Any","default":0},{"name":"close_modal","kind":"Any","default":0}]},{"type":"model","name":"BootstrapTemplateActions1","properties":[{"name":"open_modal","kind":"Any","default":0},{"name":"close_modal","kind":"Any","default":0}]},{"type":"model","name":"MaterialTemplateActions1","properties":[{"name":"open_modal","kind":"Any","default":0},{"name":"close_modal","kind":"Any","default":0}]}]}};
  var render_items = [{"docid":"07f2c1fa-7f76-4757-8ccd-91ca714f99c2","roots":{"p1176":"b4f62c71-211b-43e6-abf7-0879049de0e9"},"root_ids":["p1176"]}];
  var docs = Object.values(docs_json)
  if (!docs) {
    return
  }
  const py_version = docs[0].version.replace('rc', '-rc.').replace('.dev', '-dev.')
  const is_dev = py_version.indexOf("+") !== -1 || py_version.indexOf("-") !== -1
  function embed_document(root) {
    var Bokeh = get_bokeh(root)
    Bokeh.embed.embed_items_notebook(docs_json, render_items);
    for (const render_item of render_items) {
      for (const root_id of render_item.root_ids) {
    const id_el = document.getElementById(root_id)
    if (id_el.children.length && (id_el.children[0].className === 'bk-root')) {
      const root_el = id_el.children[0]
      root_el.id = root_el.id + '-rendered'
    }
      }
    }
  }
  function get_bokeh(root) {
    if (root.Bokeh === undefined) {
      return null
    } else if (root.Bokeh.version !== py_version && !is_dev) {
      if (root.Bokeh.versions === undefined || !root.Bokeh.versions.has(py_version)) {
    return null
      }
      return root.Bokeh.versions.get(py_version);
    } else if (root.Bokeh.version === py_version) {
      return root.Bokeh
    }
    return null
  }
  function is_loaded(root) {
    var Bokeh = get_bokeh(root)
    return (Bokeh != null && Bokeh.Panel !== undefined)
  }
  if (is_loaded(root)) {
    embed_document(root);
  } else {
    var attempts = 0;
    var timer = setInterval(function(root) {
      if (is_loaded(root)) {
        clearInterval(timer);
        embed_document(root);
      } else if (document.readyState == "complete") {
        attempts++;
        if (attempts > 200) {
          clearInterval(timer);
      var Bokeh = get_bokeh(root)
      if (Bokeh == null || Bokeh.Panel == null) {
            console.warn("Panel: ERROR: Unable to run Panel code because Bokeh or Panel library is missing");
      } else {
        console.warn("Panel: WARNING: Attempting to render but not all required libraries could be resolved.")
        embed_document(root)
      }
        }
      }
    }, 25, root)
  }
})(window);</script>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="178">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>importance</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="178">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Feature</th>
<th data-quarto-table-cell-role="th">Importance</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>laggedTrips</td>
<td>0.527783</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>logDistRests</td>
<td>0.213952</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>logStationDists</td>
<td>0.101589</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>totalDocks</td>
<td>0.091017</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>logIntersectionDists</td>
<td>0.035010</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>percent_car</td>
<td>0.030233</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>within_centerCity</td>
<td>0.000417</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="lets-analyze-the-spatial-structure-of-the-predictions-visually" class="level3">
<h3 class="anchored" data-anchor-id="lets-analyze-the-spatial-structure-of-the-predictions-visually">Let’s analyze the spatial structure of the predictions visually</h3>
<p>We’ll plot the predicted and actual trip values</p>
<p>Use the test set index (<code>test_set.index</code>) to get the data from the original data frame (<code>bike_data</code>).</p>
<p>This will ensure we will have <code>geometry</code> info (not used in the modeling) for our test data set:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="171">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>test_set.index</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="171">
<pre><code>Int64Index([ 44,  99,  21, 106,  43, 115,  87,   2,  16,  75, 112,  39,  38,
             31,  78,  58,  54,  76,  33,  69,   6,  49,  57,  37, 101,  93,
             30,  25,  77,  11,  67,  94,  79,  17,  56,  89, 103,  80,  55,
             90,  29,   1,   4,  92,  74, 113,  27],
           dtype='int64')</code></pre>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="172">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the test data from the original dataset</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This will include the geometry data</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> bike_data.loc[test_set.index]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="173">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># test data extracted from our original data frame</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>X.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="173">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">kioskId</th>
<th data-quarto-table-cell-role="th">start_station</th>
<th data-quarto-table-cell-role="th">total_start_trips</th>
<th data-quarto-table-cell-role="th">totalDocks</th>
<th data-quarto-table-cell-role="th">percent_car</th>
<th data-quarto-table-cell-role="th">logDistRests</th>
<th data-quarto-table-cell-role="th">within_centerCity</th>
<th data-quarto-table-cell-role="th">logIntersectionDists</th>
<th data-quarto-table-cell-role="th">logStationDists</th>
<th data-quarto-table-cell-role="th">laggedTrips</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">44</td>
<td>POINT (-8367887.236 4861171.207)</td>
<td>3058</td>
<td>3058</td>
<td>45196</td>
<td>19</td>
<td>0.496881</td>
<td>2.596062</td>
<td>0</td>
<td>1.465972</td>
<td>2.898925</td>
<td>40267.8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">99</td>
<td>POINT (-8371072.087 4859640.417)</td>
<td>3160</td>
<td>3160</td>
<td>33808</td>
<td>40</td>
<td>0.088623</td>
<td>2.514922</td>
<td>0</td>
<td>1.711444</td>
<td>2.924112</td>
<td>36880.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">21</td>
<td>POINT (-8366456.781 4857132.697)</td>
<td>3030</td>
<td>3030</td>
<td>39669</td>
<td>29</td>
<td>0.495356</td>
<td>2.162455</td>
<td>0</td>
<td>1.584919</td>
<td>2.792573</td>
<td>38363.6</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">106</td>
<td>POINT (-8368324.722 4858873.658)</td>
<td>3168</td>
<td>3168</td>
<td>64969</td>
<td>23</td>
<td>0.299180</td>
<td>2.179807</td>
<td>1</td>
<td>1.694573</td>
<td>2.690814</td>
<td>38585.4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">43</td>
<td>POINT (-8368984.846 4860768.880)</td>
<td>3057</td>
<td>3057</td>
<td>73758</td>
<td>26</td>
<td>0.407225</td>
<td>2.772379</td>
<td>0</td>
<td>1.567825</td>
<td>2.873902</td>
<td>45498.8</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="174">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>test_set.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="174">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">totalDocks</th>
<th data-quarto-table-cell-role="th">percent_car</th>
<th data-quarto-table-cell-role="th">logDistRests</th>
<th data-quarto-table-cell-role="th">within_centerCity</th>
<th data-quarto-table-cell-role="th">logIntersectionDists</th>
<th data-quarto-table-cell-role="th">logStationDists</th>
<th data-quarto-table-cell-role="th">laggedTrips</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">44</td>
<td>19</td>
<td>0.496881</td>
<td>2.596062</td>
<td>0</td>
<td>1.465972</td>
<td>2.898925</td>
<td>40267.8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">99</td>
<td>40</td>
<td>0.088623</td>
<td>2.514922</td>
<td>0</td>
<td>1.711444</td>
<td>2.924112</td>
<td>36880.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">21</td>
<td>29</td>
<td>0.495356</td>
<td>2.162455</td>
<td>0</td>
<td>1.584919</td>
<td>2.792573</td>
<td>38363.6</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">106</td>
<td>23</td>
<td>0.299180</td>
<td>2.179807</td>
<td>1</td>
<td>1.694573</td>
<td>2.690814</td>
<td>38585.4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">43</td>
<td>26</td>
<td>0.407225</td>
<td>2.772379</td>
<td>0</td>
<td>1.567825</td>
<td>2.873902</td>
<td>45498.8</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>#### The data frame indices lines up!</p>
<p>Now, make our predictions, and convert them from log to raw counts:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="175">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions for log of total trip counts</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>log_predictions <span class="op">=</span> grid.best_estimator_.predict(test_set)</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the predicted test values from log</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>X[<span class="st">'prediction'</span>] <span class="op">=</span> np.exp(log_predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s make the plot with side-by-side panels for actual and predicted:</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="176">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot two columns</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(ncols<span class="op">=</span><span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted values</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>X.plot(ax<span class="op">=</span>axs[<span class="dv">0</span>], column<span class="op">=</span><span class="st">'prediction'</span>)</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>ctx.add_basemap(ax<span class="op">=</span>axs[<span class="dv">0</span>], crs<span class="op">=</span>X.crs, source<span class="op">=</span>ctx.providers.CartoDB.DarkMatter)</span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].set_title(<span class="st">"Predicted Trip Counts"</span>)</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Actual values</span></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>X.plot(ax<span class="op">=</span>axs[<span class="dv">1</span>], column<span class="op">=</span><span class="st">'total_start_trips'</span>)</span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>ctx.add_basemap(ax<span class="op">=</span>axs[<span class="dv">1</span>], crs<span class="op">=</span>X.crs, source<span class="op">=</span>ctx.providers.CartoDB.DarkMatter)</span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].set_title(<span class="st">"Actual Trip Counts"</span>)</span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].set_axis_off()</span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].set_axis_off()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lecture-13B_files/figure-html/cell-111-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="the-results-are-not-great" class="level3">
<h3 class="anchored" data-anchor-id="the-results-are-not-great">The results are… not great</h3>
<section id="the-good" class="level4">
<h4 class="anchored" data-anchor-id="the-good">The good</h4>
<p>We are capturing the general trend of within Center City vs.&nbsp;outside Center City</p>
</section>
<section id="the-bad" class="level4">
<h4 class="anchored" data-anchor-id="the-bad">The bad</h4>
<p>The values of the trip counts for those stations within Center City do not seem to be well-represented</p>
</section>
</section>
<section id="can-we-improve-the-model" class="level3">
<h3 class="anchored" data-anchor-id="can-we-improve-the-model">Can we improve the model?</h3>
<p>Yes!</p>
<p>This is a classic example of underfitting, for a few reasons:</p>
<ul>
<li>The analysis only used seven features. We should be able to improve the fit by adding more features, particularly features that capture information of the stations within Center City (where the model seems to be struggling).</li>
<li>The correlation analysis did not indicate much correlation between features, and the features all had a pretty large correlation with the total trip counts. So, in some sense, the features all seem to be important, and we just need to add more.</li>
</ul>
</section>
<section id="features-to-investigate" class="level3">
<h3 class="anchored" data-anchor-id="features-to-investigate">Features to investigate:</h3>
<ul>
<li>Additional census demographic data:
<ul>
<li>e.g., population, income, percent with bachelor’s degree or higher</li>
</ul></li>
<li>Amenities / disamenities
<ul>
<li>Lots of options from OpenDataPhilly and OpenStreetMap</li>
<li>Criminal incidents, distance to parks, restaurants, new construction permits, etc.</li>
</ul></li>
<li>Transportation network
<ul>
<li>Distance to the nearest bus station is a good place to start (see <a href="https://wiki.openstreetmap.org/wiki/Map_Features">https://wiki.openstreetmap.org/wiki/Map_Features</a> for the amenity tag)</li>
</ul></li>
<li>Changing <em>k</em> values for distance-based features
<ul>
<li>Experiment with different values of <em>k</em> to see if they improve the model</li>
</ul></li>
</ul>
</section>
<section id="other-options-for-bikeshare-data" class="level3">
<h3 class="anchored" data-anchor-id="other-options-for-bikeshare-data">Other options for bikeshare data</h3>
<p>When trying to improve the accuracy of the model, another option is incorporating additional data. In this case, we can look to other cities and include trip data for these cities. Some good places to start:</p>
<ul>
<li><a href="https://www.bluebikes.com/system-data">Boston</a></li>
<li><a href="https://www.divvybikes.com/system-data">Chicago</a></li>
<li><a href="https://www.capitalbikeshare.com/system-data">Washington D.C</a></li>
</ul>
</section>
</section>
<section id="thats-it" class="level2">
<h2 class="anchored" data-anchor-id="thats-it">That’s it!</h2>
<p>Next week (last week!) we’ll talk about an advanced raster data use case.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Content <i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> 2023 by <a href="https://www.nickhand.dev">Nick Hand</a>, Quarto layout adapted from <a href="https://github.com/andrewheiss/datavizs23.classes.andrewheiss.com">Andrew Heiss’s Data Visualization with R course</a> <br> All content licensed under a <i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> <i class="fa-brands fa-creative-commons-by" aria-label="creative-commons-by"></i> <i class="fa-brands fa-creative-commons-nc" aria-label="creative-commons-nc"></i> <a href="https://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International license (CC BY-NC 4.0)</a></div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">Made with <i class="fa-brands fa-python" aria-label="python"></i> and <a href="https://quarto.org/">Quarto</a><br> <a href="https://www.github.com/MUSA-550-Fall-2023/musa-550-fall-2023.github.io">View the source at <i class="fa-brands fa-github" aria-label="github"></i> GitHub</a></div>
  </div>
</footer>



</body></html>